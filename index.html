<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-21XPVF0G1Q"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-21XPVF0G1Q');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Finanzas Personal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Organiza tus ingresos y gastos de forma inteligente">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finanzas">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Ocultar elementos decorativos vac칤os */
        body > *:empty,
        body > *:not(.version-banner):not(.container):not(script):not(style) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            animation: fadeIn 0.6s ease-out;
            overflow-x: hidden;
            font-size: 0; /* Ocultar texto suelto */
        }
        
        /* Restaurar font-size en elementos espec칤ficos */
        .version-banner,
        .container,
        .version-banner *,
        .container * {
            font-size: initial;
        }
        
        body::before,
        body::after {
            display: none !important;
        }
        
        /* Ocultar texto decorativo (l칤neas/barras) */
        .container > *:empty,
        .container > div:not([class]):not([id]) {
            display: none !important;
        }
        
        /* Ocultar cualquier texto suelto que sean solo backslashes */
        body::before,
        body::after,
        .version-banner::before,
        .version-banner::after,
        .container::before,
        .container::after {
            content: none !important;
            display: none !important;
        }
        
        /* Forzar ocultamiento de elementos sin clase entre secciones principales */
        body > div:not([class]):not([id]),
        body > span:not([class]):not([id]),
        .version-banner + *:not(.container),
        .container > *:first-child:empty {
            display: none !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.25);
            animation: slideUp 0.8s ease-out;
            position: relative;
            z-index: 1;
        }
        
        .container::before,
        .container::after {
            display: none !important;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        /* Emoji en t칤tulos - NO afectado por gradiente */
        .emoji {
            -webkit-text-fill-color: initial;
            display: inline-block;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
            font-weight: 400;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.08);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .section:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }
        
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }
        
        /* Emojis en section-title tambi칠n en color */
        .section-title .emoji {
            -webkit-text-fill-color: initial;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.95em;
            letter-spacing: 0.2px;
        }
        
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8eaf6;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #ffffff;
        }
        
        input[type="number"]:hover,
        input[type="text"]:hover {
            border-color: #c5cae9;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8eaf6;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #ffffff;
            cursor: pointer;
        }
        
        select:hover {
            border-color: #c5cae9;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .gasto-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #e8eaf6;
            transition: all 0.3s ease;
        }
        
        .gasto-item:hover {
            border-color: #c5cae9;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.08);
            transform: translateY(-2px);
        }
        
        .gasto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .gasto-nombre {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .btn-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        
        .btn-remove:hover {
            background: #ff5252;
        }
        
        .btn-calculate {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-calculate:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-calculate:active:before {
            width: 300px;
            height: 300px;
        }
        
        .btn-calculate:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }
        
        .btn-calculate:active {
            transform: translateY(-1px);
        }
        
        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-add:active {
            transform: translateY(0);
        }
        
        .resultado {
            display: none;
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 15px;
            border: 3px solid #667eea;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.15);
        }
        
        .resultado.show {
            display: block;
            animation: resultFadeIn 0.6s ease-out;
        }
        
        @keyframes resultFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        .resultado h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2em;
            font-weight: 700;
        }
        
        .resumen-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.08);
            transition: all 0.3s ease;
        }
        
        .resumen-box:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }

        .resumen-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e8eaf6;
            transition: all 0.2s ease;
        }
        
        .resumen-item:hover {
            padding-left: 8px;
            border-bottom-color: #c5cae9;
        }
        
        .resumen-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 15px 0 0 0;
            margin-top: 10px;
            border-top: 2px solid #e8eaf6;
        }
        
        .resumen-item:last-child:hover {
            padding-left: 0;
        }
        
        .calendario-pago {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.08);
            transition: all 0.3s ease;
        }
        
        .calendario-pago:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.12);
            transform: translateY(-2px);
        }
        
        .pago-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .pago-detalle {
            padding-left: 20px;
        }
        
        .pago-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9ff;
            border-radius: 5px;
            border-left: 3px solid #51cf66;
        }
        
        .ahorro-box {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }
        
        .ahorro-amount {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .consejos {
            background: #fff3bf;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #ffd43b;
        }
        
        .consejo-item {
            padding: 10px 0;
            color: #333;
        }
        
        .alert {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background: #51cf66;
        }
        
        /* Sem치foro de Salud Financiera */
        .health-meter {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .health-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            flex-shrink: 0;
        }
        
        .health-green { background: linear-gradient(135deg, #51cf66, #37b24d); }
        .health-yellow { background: linear-gradient(135deg, #ffd43b, #fab005); }
        .health-red { background: linear-gradient(135deg, #ff6b6b, #fa5252); }
        
        .health-info h3 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .health-info p {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Barra de Progreso */
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #37b24d);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        /* Alertas Inteligentes */
        .smart-alerts {
            margin: 20px 0;
        }
        
        .alert-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideIn 0.3s;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .alert-success {
            background: #d1e7dd;
            border-left: 4px solid #51cf66;
        }
        
        .alert-info {
            background: #cfe2ff;
            border-left: 4px solid #0d6efd;
        }
        
        .alert-item .icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }
        
        .alert-item .content {
            flex: 1;
        }
        
        .alert-item strong {
            display: block;
            margin-bottom: 5px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container canvas {
            max-height: 400px !important;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-close {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .month-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .month-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .month-card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .month-card-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-positive {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .status-negative {
            background: #f8d7da;
            color: #842029;
        }
        
        .month-card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .month-detail {
            font-size: 0.9em;
            color: #666;
        }
        
        .month-detail strong {
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .section, .btn-calculate, .btn-add, .btn-remove, button, h1, .subtitle {
                display: none !important;
            }
            
            .resultado {
                display: block !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            .resumen-box, .calendario-pago, .ahorro-box, .consejos, .health-meter, .chart-container, .smart-alerts {
                page-break-inside: avoid;
                box-shadow: none !important;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* ESTILOS DEL RECUADRO DE VERSI칍N */
        .version-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 50px 15px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
            overflow: hidden;
        }
        
        .version-banner::before,
        .version-banner::after {
            display: none !important;
        }
        
        /* PANEL DE NOTIFICACIONES */
        #notificaciones-panel {
            background: linear-gradient(135deg, #ffd43b 0%, #ff9800 100%);
            color: #333;
            padding: 15px 20px;
            margin: 0 auto 20px;
            max-width: 900px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(255, 159, 0, 0.3);
            animation: slideDown 0.5s ease-out 0.3s both;
        }
        
        #notificaciones-panel h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notificacion-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .notificacion-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid #ff6b6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        
        .notificacion-urgente {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .notificacion-normal {
            border-left-color: #ffd43b;
            background: #fffbf0;
        }
        
        .btn-install-pwa {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn-install-pwa:hover {
            background: #667eea;
            color: white;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .version-banner h3 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .version-banner p {
            margin: 0;
            font-size: 0.95em;
            opacity: 0.95;
        }
        
        .version-close {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .version-close:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9em;
        }
        
        /* ESTILOS TABLA COMPACTA GASTOS FIJOS */
        /* ===== LISTA COMPACTA DE GASTOS FIJOS ===== */
        .gastos-fijos-lista {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1.5px solid #e8eaf6;
        }
        .gastos-fijos-header {
            display: grid;
            grid-template-columns: 2fr 1.1fr 0.65fr 1.2fr 1.2fr 76px;
            gap: 8px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 0.82em;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        .gasto-fijo-row {
            display: grid;
            grid-template-columns: 2fr 1.1fr 0.65fr 1.2fr 1.2fr 76px;
            gap: 8px;
            padding: 7px 14px;
            align-items: center;
            border-bottom: 1px solid #f0f0f8;
            transition: background 0.18s;
        }
        .gasto-fijo-row:last-child { border-bottom: none; }
        .gasto-fijo-row:hover { background: #f8f9ff; }
        .gasto-fijo-row input[type="text"],
        .gasto-fijo-row input[type="number"],
        .gasto-fijo-row select {
            width: 100%;
            padding: 7px 9px;
            border: 1.5px solid #e8eaf6;
            border-radius: 7px;
            font-size: 0.9em;
            transition: all 0.2s;
            background: #fafbff;
        }
        .gasto-fijo-row input:focus,
        .gasto-fijo-row select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .gasto-fijo-acciones { display: flex; gap: 5px; justify-content: center; }
        .btn-eliminar-fila {
            background: #ff6b6b; color: white; border: none;
            padding: 6px 10px; border-radius: 5px;
            cursor: pointer; font-size: 1.1em; transition: all 0.2s;
        }
        .btn-eliminar-fila:hover { background: #ff5252; transform: scale(1.1); }
        .btn-copiar-fila {
            background: #51cf66; color: white; border: none;
            padding: 6px 10px; border-radius: 5px;
            cursor: pointer; font-size: 1.1em; transition: all 0.2s;
        }
        .btn-copiar-fila:hover { background: #37b24d; transform: scale(1.1); }
        @media (max-width: 600px) {
            .gastos-fijos-header { display: none; }
            .gasto-fijo-row {
                grid-template-columns: 1fr 1fr;
                padding: 10px 12px;
                gap: 7px;
            }
            .gasto-fijo-row .gasto-col-nombre { grid-column: 1 / -1; }
            .gasto-fijo-row .gasto-col-acciones { grid-column: 1 / -1; justify-content: flex-end; }
        }

        /* ===== RESUMEN R츼PIDO ===== */
        #resumen-rapido {
            margin-top: 8px;
            font-size: 0.88em;
            font-weight: 600;
            min-height: 0;
            transition: all 0.3s;
        }
        .resumen-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 13px;
            border-radius: 20px;
            border: 1.5px solid currentColor;
            background: rgba(255,255,255,0.55);
        }
        .resumen-positivo { color: #2e7d32; }
        .resumen-negativo { color: #c62828; }

        /* ===== TOAST DE ACTUALIZACI칍N ===== */
        .toast-update {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1b2e;
            color: #e2e8f0;
            padding: 12px 18px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            z-index: 9999;
            transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 0.9em;
            white-space: nowrap;
        }
        .toast-update.show { bottom: 24px; }
        #btn-actualizar-sw {
            background: #667eea; color: white; border: none;
            padding: 6px 14px; border-radius: 7px;
            cursor: pointer; font-weight: 600; font-size: 0.9em;
            transition: background 0.2s;
        }
        #btn-actualizar-sw:hover { background: #764ba2; }
        .toast-update > button:last-child {
            background: none; border: none;
            color: rgba(255,255,255,0.5); cursor: pointer;
            font-size: 1.1em; padding: 0 4px;
        }
        
        .btn-agregar-fila {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        
        .btn-agregar-fila:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* ESTILOS DE VALIDACI칍N */
        .input-error {
            border-color: #ff6b6b !important;
            background: #fff5f5 !important;
            animation: shake 0.3s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .error-message.show {
            display: block;
        }
        
        .error-message strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        
        .error-message ul {
            margin: 10px 0 0 20px;
            list-style: disc;
        }
        
        .error-message li {
            margin: 5px 0;
        }
        
        .success-message {
            background: #51cf66;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
        }
        
        .success-message.show {
            display: block;
        }
        
        /* ==================== RESPONSIVE - M칍VIL Y TABLET ==================== */
        
        /* TABLET (pantallas menores a 900px) */
        @media (max-width: 900px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Grid de gastos variables en m칩vil */
            .section [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .gastos-fijos-header {
                font-size: 0.78em;
                padding: 8px 12px;
            }
        }
        
        /* M칍VIL (pantallas menores a 600px) */
        @media (max-width: 600px) {
            .version-banner {
                padding: 12px 45px 12px 15px;
                margin-bottom: 10px;
            }
            
            .version-banner h3 {
                font-size: 1em;
                margin-bottom: 5px;
            }
            
            .version-banner p {
                font-size: 0.85em;
                line-height: 1.3;
            }
            
            .version-badge {
                font-size: 0.8em;
                padding: 3px 10px;
                display: inline-block;
                margin-bottom: 3px;
            }
            
            .version-close {
                width: 28px;
                height: 28px;
                font-size: 1.1em;
                right: 10px;
            }
            
            .container {
                margin: 10px;
                padding: 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 0.95em;
                margin-bottom: 25px;
            }
            
            .section {
                padding: 20px;
                margin-bottom: 25px;
            }
            
            .section-title {
                font-size: 1.3em;
            }
            
            /* Botones m치s grandes para touch */
            .btn-calculate,
            .btn-add,
            .btn-agregar-fila {
                padding: 15px;
                font-size: 1.05em;
                min-height: 50px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
            
            /* Inputs m치s grandes para m칩vil */
            input[type="number"],
            input[type="text"],
            select {
                padding: 14px 12px;
                font-size: 16px; /* Evita zoom en iOS */
                min-height: 48px;
            }
            
            
            
            /* Bot칩n eliminar m치s grande en m칩vil */
            .btn-eliminar-fila {
                padding: 10px 15px;
                font-size: 1.3em;
                min-width: 50px;
                min-height: 50px;
            }
            
            /* Tarjetas m치s compactas */
            .gasto-categoria {
                padding: 15px;
            }
            
            /* Version banner responsive */
            .version-banner {
                padding: 12px 15px;
            }
            
            .version-banner h3 {
                font-size: 1em;
            }
            
            .version-banner p {
                font-size: 0.85em;
            }
            
            .version-badge {
                font-size: 0.8em;
                padding: 3px 10px;
            }
            
            .version-close {
                width: 25px;
                height: 25px;
                font-size: 1em;
                right: 10px;
            }
            
            /* Mensajes de error m치s compactos */
            .error-message,
            .success-message {
                padding: 12px 15px;
                font-size: 0.9em;
            }
            
            .error-message ul {
                margin-left: 15px;
            }
            
            /* Health meter responsive */
            .health-meter {
                flex-direction: column;
                text-align: center;
            }
            
            .health-circle {
                margin-bottom: 15px;
            }
            
            /* Gr치fica responsive */
            .chart-container {
                padding: 15px;
            }
            
            /* Resumen boxes */
            .resumen-box {
                padding: 15px;
            }

            .resumen-item {
                padding: 10px;
                font-size: 0.9em;
            }

            .action-buttons { flex-direction: column; }
            .action-buttons .btn-secondary { text-align: center; }
            .resultado { padding: 15px; }
            .pago-title { font-size: 0.9em; padding: 12px; }
        }

        /* M칍VIL PEQUE칌O (pantallas menores a 400px) */
        @media (max-width: 400px) {
            .container {
                margin: 10px 5px;
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .section {
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.2em;
            }
            
            input[type="number"],
            input[type="text"],
            select {
                padding: 12px 10px;
            }
        }

        /* M칍VIL MUY PEQUE칌O (pantallas menores a 380px) */
        @media (max-width: 380px) {
            .container { padding: 12px; margin: 5px; }
            .section { padding: 14px; }
            .gasto-fijo-row { grid-template-columns: 1fr; }
            .gasto-fijo-row .gasto-col-nombre,
            .gasto-fijo-row .gasto-col-acciones { grid-column: unset; }
            .header-row h1 { font-size: 1.4em; }
            .theme-toggle { width: 36px; height: 36px; font-size: 1.1em; }
            .btn-calculate { font-size: 1em; padding: 16px; }
        }

        /* ==================== AYUDA CONTEXTUAL Y TOOLTIPS ==================== */
        
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: #667eea;
            color: white;
            -webkit-text-fill-color: white;
            border-radius: 50%;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
            cursor: help;
            position: relative;
            transition: all 0.3s;
        }
        
        .help-icon:hover {
            background: #5568d3;
            transform: scale(1.1);
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: #2d3748;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: normal;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            max-width: 300px;
            text-align: left;
        }
        
        .tooltip:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2d3748;
        }
        
        .help-icon:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }
        
        .help-text {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 12px 15px;
            margin-top: 8px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #666;
        }
        
        .help-text strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .example-box {
            background: #fff9e6;
            border: 2px dashed #ffd43b;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .example-box h4 {
            color: #f59f00;
            margin: 0 0 10px 0;
            font-size: 0.95em;
        }
        
        .example-box ul {
            margin: 8px 0 0 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        .example-box li {
            margin: 5px 0;
        }
        
        .collapsible-help {
            background: #f8f9ff;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }
        
        .collapsible-header:hover {
            background: #5568d3;
        }
        
        .collapsible-header .arrow {
            transition: transform 0.3s;
        }
        
        .collapsible-header.active .arrow {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 15px;
        }
        
        .collapsible-content.active {
            max-height: 500px;
            padding: 15px;
        }
        
        .quick-tip {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quick-tip:before {
            content: '游눠';
            font-size: 1.3em;
        }
        
        /* ==================== BARRA DE PRESUPUESTOS ==================== */
        
        .barra-presupuestos {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #4caf50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .presupuesto-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .selector-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }
        
        .presupuesto-label {
            font-weight: bold;
            color: #2e7d32;
            white-space: nowrap;
            font-size: 1em;
        }
        
        #presupuesto-selector {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #4caf50;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            font-weight: 600;
            color: #2e7d32;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #presupuesto-selector:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .botones-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-presupuesto {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .btn-presupuesto:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-presupuesto:active {
            transform: translateY(0);
        }
        
        .btn-nuevo {
            background: #4caf50;
        }
        
        .btn-nuevo:hover {
            background: #45a049;
        }
        
        .btn-copiar {
            background: #2196f3;
        }
        
        .btn-copiar:hover {
            background: #1976d2;
        }
        
        .btn-eliminar {
            background: #f44336;
        }
        
        .btn-eliminar:hover {
            background: #d32f2f;
        }
        
        .btn-limpiar {
            background: #ff9800;
        }
        
        .btn-limpiar:hover {
            background: #f57c00;
        }
        
        #autosave-indicator {
            margin-top: 12px;
            font-size: 0.85em;
            color: #2e7d32;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: left;
            font-weight: 500;
        }
        
        /* RESPONSIVE PARA BARRA DE PRESUPUESTOS */
        
        @media (max-width: 600px) {
            .barra-presupuestos {
                padding: 15px;
            }
            
            .presupuesto-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .selector-container {
                min-width: 100%;
                flex-direction: column;
                align-items: stretch;
            }
            
            .presupuesto-label {
                margin-bottom: 8px;
            }
            
            #presupuesto-selector {
                padding: 14px 12px;
                min-height: 48px;
                width: 100%;
            }
            
            .botones-container {
                margin-top: 10px;
                gap: 8px;
            }
            
            .btn-presupuesto {
                padding: 14px 16px;
                min-height: 48px;
                flex: 1;
                min-width: 0;
                font-size: 0.9em;
            }
            
            #autosave-indicator {
                text-align: center;
                margin-top: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .barra-presupuestos {
                padding: 12px;
            }
            
            .presupuesto-label {
                font-size: 0.9em;
            }
            
            #presupuesto-selector {
                font-size: 0.95em;
                padding: 12px 10px;
            }
            
            .botones-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .btn-presupuesto {
                width: 100%;
                padding: 12px 8px;
                font-size: 0.8em;
            }
            .header-row { margin-bottom: 6px; }
            .theme-toggle { width: 38px; height: 38px; }
        }

        /* ===== TOGGLE DE TEMA ===== */
        .header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 10px;
        }
        .theme-toggle {
            position: absolute;
            right: 0;
            background: rgba(102, 126, 234, 0.12);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .theme-toggle:hover {
            background: rgba(102, 126, 234, 0.22);
            transform: rotate(15deg) scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
        }

        /* ===== MODO OSCURO ===== */
        [data-theme="dark"] .container {
            background: #1a1b2e;
            box-shadow: 0 25px 70px rgba(0,0,0,0.55);
        }
        [data-theme="dark"] .section {
            background: linear-gradient(135deg, #252640 0%, #1e1f35 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .section:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.45);
        }
        [data-theme="dark"] .subtitle { color: #94a3b8; }
        [data-theme="dark"] label { color: #94a3b8; }
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="text"] {
            background: #2d2d44;
            border-color: #3d3d58;
            color: #e2e8f0;
        }
        [data-theme="dark"] input[type="number"]:hover,
        [data-theme="dark"] input[type="text"]:hover { border-color: #667eea; }
        [data-theme="dark"] input[type="number"]:focus,
        [data-theme="dark"] input[type="text"]:focus { background: #333355; }
        [data-theme="dark"] select {
            background: #2d2d44;
            border-color: #3d3d58;
            color: #e2e8f0;
        }
        [data-theme="dark"] .gasto-item {
            background: #252640;
            border-color: #3d3d58;
        }
        [data-theme="dark"] .resumen-box { background: #252640; }
        [data-theme="dark"] .resultado {
            background: linear-gradient(135deg, #252640 0%, #1e1f35 100%);
        }
        [data-theme="dark"] .barra-presupuestos {
            background: linear-gradient(135deg, #1e2d1e 0%, #1a2a1e 100%);
        }
        [data-theme="dark"] .chart-container { background: #252640; }
        [data-theme="dark"] .modal-content {
            background: #1e1f35;
            color: #e2e8f0;
        }
        [data-theme="dark"] .modal-header { border-color: #3d3d58; }
        [data-theme="dark"] .alert-warning {
            background: #3d3010;
            border-color: #ffc107;
        }
        [data-theme="dark"] .alert-success {
            background: #0d2b18;
            border-color: #51cf66;
        }
        [data-theme="dark"] .alert-info {
            background: #0a1e35;
            border-color: #0d6efd;
        }
        [data-theme="dark"] .consejo-item,
        [data-theme="dark"] .health-info h3,
        [data-theme="dark"] .month-detail strong { color: #cbd5e1; }
        [data-theme="dark"] .theme-toggle {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
        }
        [data-theme="dark"] .gastos-fijos-lista { background: #252640; border-color: #3d3d58; }
        [data-theme="dark"] .gasto-fijo-row { border-color: #2d2d44; }
        [data-theme="dark"] .gasto-fijo-row:hover { background: #2d2d44; }
        [data-theme="dark"] .gasto-fijo-row input,
        [data-theme="dark"] .gasto-fijo-row select { background: #2d2d44; border-color: #3d3d58; color: #e2e8f0; }
        [data-theme="dark"] .resumen-badge { background: rgba(255,255,255,0.08); }

        /* Catch-all: inline styles con colores oscuros  texto legible en dark */
        [data-theme="dark"] [style*="color: #666"] { color: #94a3b8 !important; }
        [data-theme="dark"] [style*="color:#666"]  { color: #94a3b8 !important; }
        [data-theme="dark"] [style*="color: #333"] { color: #e2e8f0 !important; }
        [data-theme="dark"] [style*="color:#333"]  { color: #e2e8f0 !important; }
        [data-theme="dark"] [style*="color: #4a5568"] { color: #94a3b8 !important; }
        [data-theme="dark"] [style*="color: #2e7d32"] { color: #86efac !important; }
        [data-theme="dark"] .health-info p        { color: #94a3b8; }
        [data-theme="dark"] .help-text            { background: #1e2030; color: #94a3b8; }
        [data-theme="dark"] .example-box          { background: #2a2510; border-color: #ffd43b; }
        [data-theme="dark"] .example-box ul       { color: #94a3b8; }
        [data-theme="dark"] .example-box h4       { color: #fbbf24; }
        [data-theme="dark"] .presupuesto-label    { color: #86efac; }
        [data-theme="dark"] #autosave-indicator   { color: #86efac; }
        [data-theme="dark"] .resumen-positivo     { color: #86efac; }
        [data-theme="dark"] .resumen-negativo     { color: #fca5a5; }
        [data-theme="dark"] .pago-item            { background: #1e2030; }
        [data-theme="dark"] .resumen-item         { border-color: #3d3d58; }
        [data-theme="dark"] .consejos             { background: #2a2510; border-color: #ffd43b; }
        [data-theme="dark"] .modal-header h2      { color: #e2e8f0; }

        /* ===== RESULTADO REDISE칌ADO  v3.0.4 ===== */
        .resultado-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            margin: -30px -30px 25px -30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .resultado-header h2 {
            background: none !important;
            -webkit-text-fill-color: white !important;
            color: white;
            font-size: 1.5em;
            margin: 0;
        }
        .health-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .resultado-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border-top: 3px solid #667eea;
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-icon { font-size: 1.6em; margin-bottom: 4px; }
        .metric-label { font-size: 0.72em; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1.3em; font-weight: 700; margin-top: 4px; }
        .metric-value.positivo { color: #37b24d; }
        .metric-value.negativo { color: #ff6b6b; }
        .metric-value.neutro   { color: #667eea; }
        .paycheck-card {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 4px 18px rgba(102,126,234,0.1);
            border: 1.5px solid #e8eaf6;
        }
        .paycheck-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 18px;
            font-weight: 700;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .paycheck-card-body { padding: 12px 15px; }
        .gasto-linea {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.9em;
        }
        .gasto-linea-icon { font-size: 1.1em; flex-shrink: 0; margin-top: 1px; }
        .gasto-linea-info { flex: 1; }
        .gasto-linea-monto { font-weight: 700; white-space: nowrap; }
        .gasto-linea.tipo-tarjeta  { background: #f0f2ff; border-left: 3px solid #667eea; }
        .gasto-linea.tipo-variable { background: #f0fff4; border-left: 3px solid #51cf66; }
        .gasto-linea.tipo-imprevisto { background: #fff5f5; border-left: 3px solid #ff6b6b; }
        .gasto-linea.tipo-misc     { background: #fffbf0; border-left: 3px solid #ffd43b; }
        .gasto-linea.tipo-fijo     { background: #f8f9ff; border-left: 3px solid #94a3b8; }
        .paycheck-total {
            margin-top: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f0f2ff, #f8f9ff);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 0.95em;
            border-top: 2px solid #e8eaf6;
        }
        [data-theme="dark"] .metric-card { background: #252640; border-top-color: #667eea; box-shadow: none; }
        [data-theme="dark"] .metric-label { color: #64748b; }
        [data-theme="dark"] .paycheck-card { background: #1e1f35; border-color: #3d3d58; box-shadow: none; }
        [data-theme="dark"] .gasto-linea.tipo-fijo     { background: #252640; }
        [data-theme="dark"] .gasto-linea.tipo-tarjeta  { background: #1a2035; }
        [data-theme="dark"] .gasto-linea.tipo-variable { background: #0d2b18; }
        [data-theme="dark"] .gasto-linea.tipo-imprevisto { background: #2b0d0d; }
        [data-theme="dark"] .gasto-linea.tipo-misc     { background: #2a2510; }
        [data-theme="dark"] .paycheck-total { background: #252640; border-color: #3d3d58; color: #e2e8f0; }
        [data-theme="dark"] .resultado-header { background: linear-gradient(135deg, #4a5890 0%, #5a3d82 100%); }
        @media (max-width: 600px) {
            .resultado-metrics { grid-template-columns: 1fr 1fr; }
            .resultado-header { margin: -15px -15px 18px -15px; padding: 18px; }
            .resultado-header h2 { font-size: 1.2em; }
            .metric-card { padding: 12px 8px; }
            .metric-value { font-size: 1.1em; }
            .paycheck-card-header { font-size: 0.85em; padding: 11px 14px; }
            .paycheck-card-body { padding: 10px 12px; }
            .gasto-linea { padding: 8px 10px; font-size: 0.85em; }
            .paycheck-total { font-size: 0.88em; padding: 10px 12px; }
        }

    </style>
    <script>
        (function(){
            var t = localStorage.getItem('tema') ||
                    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', t);
        })();
    </script>
</head>
<body>
    <!-- RECUADRO DE VERSI칍N -->
    <div class="version-banner" id="version-banner">
        <button class="version-close" onclick="document.getElementById('version-banner').style.display='none'" title="Cerrar">칑</button>
        <h3>
            <span class="version-badge">v3.0.4</span>
            游꿛 Redise침o Resultado
        </h3>
        <p>游님 Mejor mobile + 游깿 Dark mode corregido + 游늵 Cards de resultado modernas</p>
    </div>
    
    <!-- PANEL DE NOTIFICACIONES/RECORDATORIOS -->
    <div id="notificaciones-panel" style="display: none;"></div>
    
    <div class="container">
        <div class="header-row">
            <h1><span class="emoji">游눯</span> Organizador de Finanzas</h1>
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Cambiar a modo oscuro">游깿</button>
        </div>
        <p class="subtitle">Organiza tus ingresos y gastos de forma inteligente</p>
        

        <!-- BARRA DE CONTROL DE PRESUPUESTOS -->
        <div class="barra-presupuestos">
            <div class="presupuesto-row">
                <div class="selector-container">
                    <label class="presupuesto-label">
                        游늰 Presupuesto:
                        <span class="help-icon">?
                            <span class="tooltip">Crea presupuestos separados para cada mes. Tus datos se guardan autom치ticamente. Usa "Copiar" para duplicar un mes completo en segundos.</span>
                        </span>
                    </label>
                    <select id="presupuesto-selector" onchange="cambiarPresupuesto()">
                    </select>
                </div>
                <div class="botones-container">
                    <button onclick="nuevoPresupuesto()" class="btn-presupuesto btn-nuevo">游 Nuevo</button>
                    <button onclick="copiarPresupuesto()" class="btn-presupuesto btn-copiar">游늶 Copiar</button>
                    <button onclick="eliminarPresupuesto()" class="btn-presupuesto btn-eliminar">游딈勇 Eliminar</button>
                    <button onclick="limpiarTodo()" class="btn-presupuesto" style="background: #ff9800;">游빛 Limpiar Todo</button>
                </div>
            </div>
            <div id="autosave-indicator">游 Guardado autom치ticamente</div>
            <div id="resumen-rapido"></div>
        </div>
        
<!-- AYUDA GENERAL COLAPSABLE -->
        <div class="collapsible-help">
            <div class="collapsible-header" onclick="toggleHelp(this)">
                <span>仇 쮺칩mo usar esta aplicaci칩n?</span>
                <span class="arrow">郊</span>
            </div>
            <div class="collapsible-content">
                <h3 style="color: #667eea; margin-bottom: 15px;">游늶 Gu칤a R치pida</h3>
                
                <p style="margin-bottom: 15px;"><strong>Paso 1: Ingresos</strong></p>
                <p style="color: #666; margin-bottom: 15px;">Define cu치ndo recibes dinero (d칤a 15, 30, etc.) y cu치nto ($800, $1,200, etc.)</p>
                
                <p style="margin-bottom: 15px;"><strong>Paso 2: Gastos Fijos</strong></p>
                <p style="color: #666; margin-bottom: 15px;">Agrega tus gastos mensuales: Agua, Luz, Internet, Renta, etc. con su d칤a de vencimiento.</p>
                
                <p style="margin-bottom: 15px;"><strong>Paso 3: Tarjetas (Opcional)</strong></p>
                <p style="color: #666; margin-bottom: 15px;">Si tienes tarjetas de cr칠dito, pon el pago m칤nimo y cu치nto debes.</p>
                
                <p style="margin-bottom: 15px;"><strong>Paso 4: Calcular</strong></p>
                <p style="color: #666; margin-bottom: 15px;">Click en "游빑 CALCULAR" y ver치s tu plan financiero completo.</p>
                
                <div class="quick-tip" style="margin-top: 15px;">
                    Todos los campos con <span class="help-icon" style="display: inline-flex; vertical-align: middle;">?</span> tienen ayuda adicional. Pasa el mouse sobre ellos.
                </div>
            </div>
        </div>
        
        <!-- SECCI칍N DE INGRESOS -->
        <div class="section">
            <h2 class="section-title">
                <span class="emoji">游눳</span> Tus Ingresos y Capital
                <span class="help-icon">?
                    <span class="tooltip">Aqu칤 defines cu치ndo y cu치nto dinero recibes cada mes. Esto es la base de tu presupuesto.</span>
                </span>
            </h2>
            
            <div class="example-box">
                <h4>游닇 Ejemplo:</h4>
                <ul>
                    <li>PayCheck 1: D칤a 15  $800</li>
                    <li>PayCheck 2: D칤a 30  $800</li>
                    <li>Balance actual: $150 (lo que tienes ahora)</li>
                </ul>
            </div>
            
            <!-- BALANCE ACTUAL (OPCIONAL) -->
            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #51cf66;">
                <h3 style="color: #37b24d; margin-bottom: 15px;">
                    游눯 쯊ienes dinero guardado?
                    <span class="help-icon">?
                        <span class="tooltip">Dinero disponible AHORA (banco o efectivo). Si no tienes, d칠jalo en 0.</span>
                    </span>
                </h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    Si tienes dinero guardado, el sistema lo usar치 para pagar gastos que vencen antes de tu primer pago.
                </p>
                <div class="input-group">
                    <label>游눳 Dinero disponible ahora</label>
                    <input type="number" id="balance-actual" min="0" step="0.01" placeholder="0.00" value="0">
                </div>
                <div class="quick-tip">
                    Ejemplo: Si tienes $100 en el banco, escribe 100. Si no tienes nada, deja 0.
                </div>
            </div>
            
            <!-- META DE AHORRO -->
            <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #ff9800;">
                <h3 style="color: #f57c00; margin-bottom: 15px;">游꿢 쯈uieres ahorrar?</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    Dime cu치nto quieres ahorrar y el sistema te dir치 cu치nto guardar cada mes.
                </p>
                
                <!-- Opciones de ahorro -->
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                        <input type="radio" name="tipo-ahorro" value="mensual" checked onclick="cambiarTipoAhorro('mensual')" style="margin-right: 10px;">
                        <strong>Ahorrar cada mes</strong> <span style="color: #666; margin-left: 5px;">(la misma cantidad siempre)</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="tipo-ahorro" value="fecha" onclick="cambiarTipoAhorro('fecha')" style="margin-right: 10px;">
                        <strong>Ahorrar para una fecha</strong> <span style="color: #666; margin-left: 5px;">(vacaciones, emergencias, etc.)</span>
                    </label>
                </div>
                
                <!-- Modo: Ahorro Mensual Fijo -->
                <div id="ahorro-mensual" style="display: block;">
                    <div class="input-group">
                        <label>游눑 쮺u치nto quieres ahorrar cada mes?</label>
                        <input type="number" id="meta-ahorro" min="0" step="0.01" placeholder="200.00" oninput="calcularAhorroMensual()">
                    </div>
                </div>
                
                <!-- Modo: Ahorro con Fecha -->
                <div id="ahorro-fecha" style="display: none;">
                    <div class="input-group">
                        <label>游눯 쮺u치nto necesitas juntar?</label>
                        <input type="number" id="meta-total" min="0" step="0.01" placeholder="2000.00" oninput="calcularAhorroConFecha()">
                    </div>
                    <div class="input-group">
                        <label>游늰 쯇ara cu치ndo?</label>
                        <input type="date" id="fecha-objetivo" oninput="calcularAhorroConFecha()" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;">
                    </div>
                    
                    <!-- Resultado del c치lculo -->
                    <div id="resultado-calculo" style="display: none; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 0.95em; color: #2e7d32; margin-bottom: 10px;">
                            游늵 <strong>Tu plan:</strong>
                        </div>
                        <div id="info-calculo"></div>
                    </div>
                </div>
            </div>
            
            <!-- SELECTOR DE TIPO DE PAGO -->
            <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #667eea;">
                <h3 style="color: #667eea; margin-bottom: 15px;">游늰 쮺on qu칠 frecuencia cobras?</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer; background: white; padding: 15px 25px; border-radius: 10px; border: 2px solid #667eea; flex: 1; min-width: 200px;">
                        <input type="radio" name="tipo-pago" value="quincenal" checked onclick="cambiarTipoPago('quincenal')" style="margin-right: 10px; transform: scale(1.3);">
                        <div>
                            <strong style="color: #667eea; font-size: 1.1em;">Quincenal</strong>
                            <div style="color: #666; font-size: 0.9em;">Cobro cada 15 d칤as (2 veces al mes)</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; background: white; padding: 15px 25px; border-radius: 10px; border: 2px solid #e0e0e0; flex: 1; min-width: 200px;">
                        <input type="radio" name="tipo-pago" value="semanal" onclick="cambiarTipoPago('semanal')" style="margin-right: 10px; transform: scale(1.3);">
                        <div>
                            <strong style="color: #667eea; font-size: 1.1em;">Semanal</strong>
                            <div style="color: #666; font-size: 0.9em;">Cobro cada semana (4 veces al mes)</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <h3 style="color: #667eea; margin-bottom: 15px;">PayCheck 1</h3>
            <div class="row">
                <div class="input-group">
                    <label>游늰 Mes</label>
                    <select id="mes-pago1" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                        <option value="1">Enero</option>
                        <option value="2" selected>Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>游늰 D칤a del mes</label>
                    <input type="number" id="dia-pago1" min="1" max="31" placeholder="15">
                </div>
            </div>
            <div class="input-group">
                <label>游눯 Cu치nto cobro</label>
                <input type="number" id="monto-pago1" min="0" step="0.01" placeholder="800.00">
            </div>
            
            <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 25px;">PayCheck 2</h3>
            <div class="row">
                <div class="input-group">
                    <label>游늰 Mes</label>
                    <select id="mes-pago2" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                        <option value="1">Enero</option>
                        <option value="2" selected>Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>游늰 D칤a del mes</label>
                    <input type="number" id="dia-pago2" min="1" max="31" placeholder="30">
                </div>
            </div>
            <div class="input-group">
                <label>游눯 Cu치nto cobro</label>
                <input type="number" id="monto-pago2" min="0" step="0.01" placeholder="800.00">
            </div>
            
            <!-- PAYCHECKS 3 Y 4 - SOLO PARA PAGO SEMANAL -->
            <div id="paychecks-semanales" style="display: none;">
                
                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 25px;">PayCheck 3</h3>
                <div class="row">
                    <div class="input-group">
                        <label>游늰 Mes</label>
                        <select id="mes-pago3" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                            <option value="1">Enero</option>
                            <option value="2" selected>Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>游늰 D칤a del mes</label>
                        <input type="number" id="dia-pago3" min="1" max="31" placeholder="15">
                    </div>
                </div>
                <div class="input-group">
                    <label>游눯 Cu치nto cobro</label>
                    <input type="number" id="monto-pago3" min="0" step="0.01" placeholder="400.00">
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px; margin-top: 25px;">PayCheck 4</h3>
                <div class="row">
                    <div class="input-group">
                        <label>游늰 Mes</label>
                        <select id="mes-pago4" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                            <option value="1">Enero</option>
                            <option value="2" selected>Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>游늰 D칤a del mes</label>
                        <input type="number" id="dia-pago4" min="1" max="31" placeholder="22">
                    </div>
                </div>
                <div class="input-group">
                    <label>游눯 Cu치nto cobro</label>
                    <input type="number" id="monto-pago4" min="0" step="0.01" placeholder="400.00">
                </div>
                
            </div>
        </div>
        
        <!-- SECCI칍N DE GASTOS VARIABLES (GASOLINA Y COMIDA) -->
        <div class="section" style="border-left-color: #51cf66;">
            <h2 class="section-title">
                <span class="emoji">游뚱</span> Gastos Variables del Mes
                <span class="help-icon">?
                    <span class="tooltip">Gastos que var칤an cada mes como gasolina y comida. Se distribuyen autom치ticamente entre tus paychecks.</span>
                </span>
            </h2>
            
            <div class="help-text">
                <strong>游눠 Tip:</strong>
                Estos gastos se dividen autom치ticamente entre tus paychecks. Por ejemplo: $400 de gasolina = $200 por paycheck (quincenal) o $100 por paycheck (semanal).
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- Gasolina -->
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #51cf66;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 2em;">久</span>
                        <h3 style="margin: 0; color: #51cf66; font-size: 1.2em;">Gasolina</h3>
                    </div>
                    <div class="input-group">
                        <label>游눯 Presupuesto mensual ($)</label>
                        <input type="number" id="gasto-gasolina" class="servicio-monto-sin-dia" data-nombre="Gasolina" min="0" step="0.01" placeholder="400.00" style="border: 2px solid #51cf66;">
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">Cu치nto gastas al mes en gasolina</small>
                    </div>
                </div>
                
                <!-- Comida -->
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #ff9800;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 2em;">游꼢</span>
                        <h3 style="margin: 0; color: #ff9800; font-size: 1.2em;">Comida/Despensa</h3>
                    </div>
                    <div class="input-group">
                        <label>游눯 Presupuesto mensual ($)</label>
                        <input type="number" id="gasto-comida" class="servicio-monto-sin-dia" data-nombre="Comida/Despensa" min="0" step="0.01" placeholder="600.00" style="border: 2px solid #ff9800;">
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">Cu치nto gastas al mes en comida</small>
                    </div>
                </div>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4caf50;">
                <strong style="color: #2e7d32;">游늵 Distribuci칩n autom치tica:</strong>
                <p style="margin: 8px 0 0 0; color: #1b5e20; font-size: 0.9em;">
                    El sistema divide estos gastos entre tus paychecks autom치ticamente. 
                    <strong>No necesitas poner d칤a de vencimiento</strong> porque son gastos continuos del mes.
                </p>
            </div>
        </div>
        
        <!-- SECCI칍N DE GASTOS FIJOS -->
        <div class="section">
            <h2 class="section-title">
                <span class="emoji">游눱</span> Tus Gastos Fijos Mensuales
                <span class="help-icon">?
                    <span class="tooltip">Gastos que se repiten cada mes: Agua, Luz, Internet, Renta, Seguros, etc.</span>
                </span>
            </h2>
            
            <div class="example-box">
                <h4>游닇 Ejemplos de gastos fijos:</h4>
                <ul>
                    <li>游눦 Agua: $45, D칤a 15, Todos los meses</li>
                    <li>游눠 Luz: $135, D칤a 20, Todos los meses</li>
                    <li>游니 Internet: $60, D칤a 14, Todos los meses</li>
                    <li>游 Renta: $800, D칤a 1, Todos los meses</li>
                </ul>
            </div>
            
            <div class="help-text">
                <strong>游눠 Tip:</strong>
                Puedes agregar tantos gastos como necesites. Click en "俱 Agregar Gasto Fijo" para cada uno.
            </div>
            
            <div class="gastos-fijos-lista">
                <div class="gastos-fijos-header">
                    <span onclick="ordenarTablaGastosFijos('nombre')" style="cursor:pointer" title="Ordenar">Nombre </span>
                    <span onclick="ordenarTablaGastosFijos('monto')" style="cursor:pointer" title="Ordenar">Monto ($) </span>
                    <span onclick="ordenarTablaGastosFijos('dia')" style="cursor:pointer" title="Ordenar">D칤a </span>
                    <span>Mes</span>
                    <span>Recurrencia</span>
                    <span></span>
                </div>
                <div id="tabla-gastos-fijos-body"></div>
            </div>
            
            <button class="btn-agregar-fila" onclick="agregarFilaGastoFijo(); return false;">俱 Agregar Gasto Fijo</button>
        </div>
        
        <!-- SECCI칍N DE TARJETAS DE CR칄DITO -->
        <div class="section" style="border-left-color: #667eea;">
            <h2 class="section-title">
                <span class="emoji">游눱</span> Tarjetas de Cr칠dito
                <span class="help-icon">?
                    <span class="tooltip">El sistema calcula cu치nto debes pagar a cada tarjeta seg칰n tu dinero disponible, priorizando las m치s importantes.</span>
                </span>
            </h2>
            
            <div class="example-box">
                <h4>游닇 Ejemplo:</h4>
                <ul>
                    <li>Visa: Pago m칤nimo $50, Debes $1,500, Vence d칤a 15</li>
                    <li>Mastercard: Pago m칤nimo $30, Debes $800, Vence d칤a 20</li>
                </ul>
            </div>
            
            <div class="quick-tip">
                El sistema SIEMPRE pagar치 el m칤nimo. Si te sobra dinero, pagar치 m치s para reducir tu deuda m치s r치pido.
            </div>
            
            <div class="gasto-categoria" style="border: 2px solid #667eea; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="gasto-header" style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <input type="text" class="tarjeta-nombre" placeholder="Visa" style="border: none; background: transparent; color: white; font-weight: bold; font-size: 1.1em; width: 100%;">
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>游눯 Pago m칤nimo</label>
                        <input type="number" class="tarjeta-minimo" min="0" step="0.01" placeholder="50.00" style="border: 2px solid #ffd43b;">
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">Lo m칤nimo que pide la tarjeta</small>
                    </div>
                    <div class="input-group">
                        <label>游눱 Cu치nto debes en total</label>
                        <input type="number" class="tarjeta-deuda" min="0" step="0.01" placeholder="1500.00" style="border: 2px solid #ff6b6b;">
                    </div>
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>游늰 Mes</label>
                        <select class="tarjeta-mes" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                            <option value="todos">Todos</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>游늰 D칤a que vence</label>
                        <input type="number" class="tarjeta-dia" min="1" max="31" placeholder="15">
                    </div>
                </div>
            </div>
            
            <div id="tarjetas-container"></div>
            <button class="btn-add" onclick="agregarTarjeta()">俱 Agregar Otra Tarjeta de Cr칠dito</button>
        </div>
        
        
        <!-- SECCI칍N DE MISCEL츼NEOS -->
        <div class="section" style="border-left-color: #ffd43b;">
            <h2 class="section-title" style="color: #f59f00;"><span class="emoji">游꿢</span> Gastos Miscel치neos (Variables)</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                Gastos extras como salidas, regalos, antojos, emergencias, etc. que no son fijos pero que debes considerar.
            </p>
            <div id="miscelaneos-container"></div>
            <button class="btn-add" onclick="agregarMiscelaneo()" style="background: #ffd43b; color: #333;">俱 Agregar Miscel치neo</button>
        </div>
        
        <!-- SECCI칍N DE GASTOS IMPREVISTOS -->
        <div class="section" style="border-left-color: #ff6b6b;">
            <h2 class="section-title" style="color: #ff6b6b;"><span class="emoji">游뚿</span> Gastos Imprevistos (Solo Este Mes)</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95em;">
                Gastos 칰nicos que NO se repiten cada mes: cumplea침os, viajes, emergencias m칠dicas, reparaciones, etc.
            </p>
            <div id="imprevistos-container"></div>
            <button class="btn-add" onclick="agregarImprevisto()" style="background: #ff6b6b; color: white;">俱 Agregar Gasto Imprevisto</button>
        </div>
        
        <!-- BOT칍N CALCULAR -->
        
        <!-- MENSAJES DE ERROR/칄XITO -->
        <div id="error-container" class="error-message">
            <strong>丘멆잺 Hay algunos problemas:</strong>
            <ul id="error-list"></ul>
        </div>
        
        <div id="success-container" class="success-message">
            九 춰Perfecto! Todos los datos son v치lidos.
        </div>
        
        <button class="btn-calculate" onclick="calcularFinanzas()">游빑 CALCULAR MI PLAN FINANCIERO</button>

        <button 
    onclick="verHistorial()" 
    class="btn-secondary" 
    style="display: block; margin: 20px auto; min-width: 200px;">
    游늭 VER MESES ANTERIORES
          </button>

        
        <!-- RESULTADOS -->
        <div id="resultado" class="resultado"></div>
        
        <!-- Modal para Historial de Meses -->
        <div id="modalHistorial" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: #667eea; margin: 0;">游늭 Historial de Meses Guardados</h2>
                    <button class="modal-close" onclick="cerrarModal('modalHistorial')">九</button>
                </div>
                <div id="historialContent"></div>
            </div>
        </div>
        
        <!-- Modal para Comparaci칩n de Meses -->
        <div id="modalComparacion" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: #667eea; margin: 0;">游늵 Comparaci칩n de Meses</h2>
                    <button class="modal-close" onclick="cerrarModal('modalComparacion')">九</button>
                </div>
                <div class="chart-container">
                    <canvas id="comparacionChart"></canvas>
                </div>
                <div id="comparacionStats" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Modal para Progreso de Ahorro -->
        <div id="modalProgreso" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: #4caf50; margin: 0;">游늵 Progreso de Ahorro con Objetivo</h2>
                    <button class="modal-close" onclick="cerrarModal('modalProgreso')">九</button>
                </div>
                <div id="progresoContent"></div>
            </div>
        </div>
    </div>
    
    <!-- FOOTER CON INFO DEL CREADOR -->
    <div style="text-align: center; padding: 20px; color: white; font-size: 0.9em; margin-top: 40px;">
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; max-width: 600px; margin: 0 auto; backdrop-filter: blur(10px);">
            <div style="margin-bottom: 10px; font-weight: 600;">
                游눹 Creado por <strong>Ismael Bigio</strong>
            </div>
            <div style="font-size: 0.85em; opacity: 0.9;">
                游닎 Para dudas o sugerencias: 
                <a href="/cdn-cgi/l/email-protection#45272c222c2a1a3120260528206b262a28" style="color: #ffd43b; text-decoration: none; font-weight: 600;">
                    <span class="__cf_email__" data-cfemail="0d6f646a64625279686e4d6068236e6260">[email&#160;protected]</span>
                </a>
            </div>
            <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.7;">
                Versi칩n 3.0.4 - Febrero 2026
            </div>
        </div>
    </div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ===== GESTI칍N DE TEMA =====
        function toggleTheme() {
            const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('tema', next);
            actualizarBotonTema();
        }

        function actualizarBotonTema() {
            const btn = document.getElementById('theme-toggle');
            if (!btn) return;
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            btn.textContent = isDark ? '驕勇' : '游깿';
            btn.title = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            const meta = document.querySelector('meta[name="theme-color"]');
            if (meta) meta.content = isDark ? '#1a1b2e' : '#667eea';
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('tema')) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                actualizarBotonTema();
            }
        });

        actualizarBotonTema();
        // ===========================

        let gastoCounter = 0;
        let miscelaneoCounter = 0;
        let gastoFijoCounter = 0;
        let tarjetaCounter = 0;
        let presupuestoActual = null;
        let autoguardadoTimeout = null;
        let deferredPrompt = null; // Para PWA install
        
        // ==================== FUNCIONES PWA ====================
        
        // Detectar si puede instalarse como PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            mostrarBotonInstalarPWA();
        });
        
        function mostrarBotonInstalarPWA() {
            const panel = document.getElementById('notificaciones-panel');
            if (!panel) return;
            
            const btnHTML = `
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px; text-align: center;">
                    <div style="margin-bottom: 10px; font-weight: bold; color: #667eea;">
                        游님 춰Instala esta app en tu dispositivo!
                    </div>
                    <p style="margin: 10px 0; font-size: 0.9em; color: #666;">
                        Agrega a tu pantalla de inicio para acceso r치pido y funcionar sin conexi칩n
                    </p>
                    <button onclick="instalarPWA()" class="btn-install-pwa">
                        拘勇 Instalar App
                    </button>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = btnHTML;
            panel.appendChild(tempDiv.firstElementChild);
        }
        
        async function instalarPWA() {
            if (!deferredPrompt) {
                alert('游님 Para instalar en iOS:\n\n1. Toca el bot칩n Compartir\n2. Selecciona "Agregar a pantalla de inicio"\n\nPara Android:\n\n1. Abre el men칰 del navegador (긽)\n2. Toca "Agregar a pantalla de inicio"');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('九 PWA instalada');
            }
            
            deferredPrompt = null;
        }
        
        // ==================== SISTEMA DE NOTIFICACIONES ====================
        
        function verificarVencimientos() {
            const hoy = new Date();
            const notificaciones = [];
            
            // Obtener gastos fijos
            const filasGastosFijos = document.querySelectorAll('#tabla-gastos-fijos-body .gasto-fijo-row');
            filasGastosFijos.forEach(fila => {
                const nombre = fila.querySelector('.gasto-fijo-nombre')?.value || '';
                const dia = parseInt(fila.querySelector('.gasto-fijo-dia')?.value) || 0;
                const mes = fila.querySelector('.gasto-fijo-mes')?.value || '';
                
                if (nombre && dia > 0) {
                    const mesGasto = (mes && mes !== 'todos') ? parseInt(mes) : (hoy.getMonth() + 1);
                    const fechaVencimiento = new Date(hoy.getFullYear(), mesGasto - 1, dia);
                    const diasHasta = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diasHasta >= 0 && diasHasta <= 7) {
                        notificaciones.push({
                            tipo: diasHasta <= 3 ? 'urgente' : 'normal',
                            titulo: nombre,
                            dias: diasHasta,
                            fecha: fechaVencimiento
                        });
                    }
                }
            });
            
            // Obtener tarjetas
            const tarjetasElements = document.querySelectorAll('#tarjetas-container .gasto-categoria');
            tarjetasElements.forEach(tarjetaEl => {
                const nombre = tarjetaEl.querySelector('.tarjeta-nombre')?.value || '';
                const dia = parseInt(tarjetaEl.querySelector('.tarjeta-dia')?.value) || 0;
                const mes = tarjetaEl.querySelector('.tarjeta-mes')?.value || '';
                
                if (nombre && dia > 0) {
                    const mesTarjeta = (mes && mes !== 'todos') ? parseInt(mes) : (hoy.getMonth() + 1);
                    const fechaVencimiento = new Date(hoy.getFullYear(), mesTarjeta - 1, dia);
                    const diasHasta = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diasHasta >= 0 && diasHasta <= 7) {
                        notificaciones.push({
                            tipo: diasHasta <= 3 ? 'urgente' : 'normal',
                            titulo: `游눱 ${nombre}`,
                            dias: diasHasta,
                            fecha: fechaVencimiento
                        });
                    }
                }
            });
            
            return notificaciones;
        }
        
        function mostrarNotificaciones() {
            const notificaciones = verificarVencimientos();
            const panel = document.getElementById('notificaciones-panel');
            
            if (!panel) return;
            
            if (notificaciones.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            // Ordenar por d칤as (m치s urgentes primero)
            notificaciones.sort((a, b) => a.dias - b.dias);
            
            let html = `
                <h3>
                    游댒 Recordatorios
                    <span class="notificacion-badge">${notificaciones.length}</span>
                </h3>
            `;
            
            notificaciones.forEach(notif => {
                const textoTiempo = notif.dias === 0 ? 'HOY' : 
                                   notif.dias === 1 ? 'Ma침ana' : 
                                   `En ${notif.dias} d칤as`;
                
                html += `
                    <div class="notificacion-item notificacion-${notif.tipo}">
                        <div>
                            <strong>${notif.titulo}</strong>
                            <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                                Vence: ${textoTiempo}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: ${notif.tipo === 'urgente' ? '#ff6b6b' : '#ff9800'};">
                            ${notif.tipo === 'urgente' ? '丘멆잺 Urgente' : '游늰'}
                        </div>
                    </div>
                `;
            });
            
            panel.innerHTML = html;
            panel.style.display = 'block';
        }
        
        // ==================== SMART SCROLL ====================
        
        function guardarScrollPosition() {
            const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
            localStorage.setItem('scrollPosition', scrollPos.toString());
        }
        
        function restaurarScrollPosition() {
            const scrollPos = localStorage.getItem('scrollPosition');
            if (scrollPos) {
                setTimeout(() => {
                    window.scrollTo({
                        top: parseInt(scrollPos),
                        behavior: 'smooth'
                    });
                }, 500);
            }
        }
        
        // Guardar scroll cada 2 segundos mientras se hace scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(guardarScrollPosition, 2000);
        });
        
        // ==================== FIN FUNCIONES PWA ====================
        
        // Agregar algunos miscel치neos de ejemplo al cargar
        window.onload = function() {
            console.log('游댃 Iniciando aplicaci칩n...');
            inicializarPresupuestos();
            activarAutoguardado();
            
            // Verificar que la tabla existe
            const tbody = document.getElementById('tabla-gastos-fijos-body');
            console.log('游늶 Tabla gastos fijos:', tbody ? '九 Encontrada' : '仇 No encontrada');
            
            const datosActuales = localStorage.getItem('presupuesto_' + presupuestoActual);
            if (!datosActuales) {
                const miscelaneosEjemplo = [
                    'Salidas/Entretenimiento',
                    'Regalos',
                    'Emergencias'
                ];
                
                miscelaneosEjemplo.forEach(nombre => {
                    agregarMiscelaneo(nombre);
                });
                
                agregarFilaGastoFijo();
            }
        };
        
        // ==================== FUNCIONES DE PRESUPUESTOS ====================
        
        function inicializarPresupuestos() {
            const presupuestos = obtenerPresupuestos();
            
            if (presupuestos.length === 0) {
                const fechaActual = new Date();
                const nombreDefault = obtenerNombreMes(fechaActual.getMonth() + 1) + ' ' + fechaActual.getFullYear();
                presupuestoActual = nombreDefault;
                guardarPresupuesto();
            } else {
                presupuestoActual = localStorage.getItem('presupuestoActual') || presupuestos[presupuestos.length - 1];
            }
            
            actualizarSelectorPresupuestos();
            cargarPresupuesto();
        }
        
        function obtenerPresupuestos() {
            const keys = Object.keys(localStorage);
            return keys.filter(key => key.startsWith('presupuesto_')).map(key => key.replace('presupuesto_', ''));
        }
        
        function actualizarSelectorPresupuestos() {
            const selector = document.getElementById('presupuesto-selector');
            const presupuestos = obtenerPresupuestos();
            
            selector.innerHTML = '';
            presupuestos.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                if (nombre === presupuestoActual) option.selected = true;
                selector.appendChild(option);
            });
        }
        
        function cambiarPresupuesto() {
            const selector = document.getElementById('presupuesto-selector');
            presupuestoActual = selector.value;
            localStorage.setItem('presupuestoActual', presupuestoActual);
            cargarPresupuesto();
        }
        
        function nuevoPresupuesto() {
            const nombre = prompt('Nombre del nuevo presupuesto (Ej: Marzo 2026):');
            if (!nombre) return;
            
            const presupuestos = obtenerPresupuestos();
            if (presupuestos.includes(nombre)) {
                alert('Ya existe un presupuesto con ese nombre');
                return;
            }
            
            presupuestoActual = nombre;
            localStorage.setItem('presupuestoActual', presupuestoActual);
            limpiarFormulario();
            actualizarSelectorPresupuestos();
            mostrarMensajeAutoguardado();
        }
        
        function copiarPresupuesto() {
            const fechaActual = new Date();
            const nombreSugerido = obtenerNombreMes(fechaActual.getMonth() + 1) + ' ' + fechaActual.getFullYear();
            const nombre = prompt('Nombre para la copia:', nombreSugerido);
            if (!nombre) return;
            
            const presupuestos = obtenerPresupuestos();
            if (presupuestos.includes(nombre)) {
                alert('Ya existe un presupuesto con ese nombre');
                return;
            }
            
            guardarPresupuesto();
            const datosActuales = localStorage.getItem('presupuesto_' + presupuestoActual);
            localStorage.setItem('presupuesto_' + nombre, datosActuales);
            
            presupuestoActual = nombre;
            localStorage.setItem('presupuestoActual', presupuestoActual);
            actualizarSelectorPresupuestos();
            cargarPresupuesto();
            
            alert('九 Presupuesto copiado exitosamente');
        }
        
        function eliminarPresupuesto() {
            const presupuestos = obtenerPresupuestos();
            if (presupuestos.length === 1) {
                alert('No puedes eliminar el 칰nico presupuesto');
                return;
            }
            
            if (!confirm(`쯉eguro que quieres eliminar "${presupuestoActual}"?\n\nEsta acci칩n no se puede deshacer.`)) {
                return;
            }
            
            localStorage.removeItem('presupuesto_' + presupuestoActual);
            const presupuestosRestantes = obtenerPresupuestos();
            presupuestoActual = presupuestosRestantes[0];
            localStorage.setItem('presupuestoActual', presupuestoActual);
            
            actualizarSelectorPresupuestos();
            cargarPresupuesto();
            alert('九 Presupuesto eliminado');
        }
        
        function obtenerNombreMes(mes) {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return meses[mes - 1];
        }
        
        function guardarPresupuesto() {
            const datos = {
                balanceActual: document.getElementById('balance-actual')?.value || '',
                metaAhorro: document.getElementById('meta-ahorro')?.value || '',
                metaTotal: document.getElementById('meta-total')?.value || '',
                fechaObjetivo: document.getElementById('fecha-objetivo')?.value || '',
                tipoPago: document.querySelector('input[name="tipo-pago"]:checked')?.value || 'quincenal',
                mesPago1: document.getElementById('mes-pago1')?.value || '',
                diaPago1: document.getElementById('dia-pago1')?.value || '',
                montoPago1: document.getElementById('monto-pago1')?.value || '',
                mesPago2: document.getElementById('mes-pago2')?.value || '',
                diaPago2: document.getElementById('dia-pago2')?.value || '',
                montoPago2: document.getElementById('monto-pago2')?.value || '',
                mesPago3: document.getElementById('mes-pago3')?.value || '',
                diaPago3: document.getElementById('dia-pago3')?.value || '',
                montoPago3: document.getElementById('monto-pago3')?.value || '',
                mesPago4: document.getElementById('mes-pago4')?.value || '',
                diaPago4: document.getElementById('dia-pago4')?.value || '',
                montoPago4: document.getElementById('monto-pago4')?.value || '',
                gastoGasolina: document.getElementById('gasto-gasolina')?.value || '',
                gastoComida: document.getElementById('gasto-comida')?.value || '',
                gastosFijos: [],
                tarjetas: [],
                miscelaneos: [],
                imprevistos: []
            };
            
            const filasGastosFijos = document.querySelectorAll('#tabla-gastos-fijos-body .gasto-fijo-row');
            filasGastosFijos.forEach(fila => {
                const nombre = fila.querySelector('.gasto-fijo-nombre')?.value || '';
                const monto = fila.querySelector('.gasto-fijo-monto')?.value || '';
                const dia = fila.querySelector('.gasto-fijo-dia')?.value || '';
                const mes = fila.querySelector('.gasto-fijo-mes')?.value || '';
                const recurrencia = fila.querySelector('.gasto-fijo-recurrencia')?.value || '';
                if (nombre || monto) datos.gastosFijos.push({ nombre, monto, dia, mes, recurrencia });
            });
            
            const tarjetasElements = document.querySelectorAll('#tarjetas-container .gasto-categoria');
            tarjetasElements.forEach(tarjetaEl => {
                const nombre = tarjetaEl.querySelector('.tarjeta-nombre')?.value || '';
                const minimo = tarjetaEl.querySelector('.tarjeta-minimo')?.value || '';
                const deuda = tarjetaEl.querySelector('.tarjeta-deuda')?.value || '';
                const mes = tarjetaEl.querySelector('.tarjeta-mes')?.value || '';
                const dia = tarjetaEl.querySelector('.tarjeta-dia')?.value || '';
                if (nombre || minimo || deuda) datos.tarjetas.push({ nombre, minimo, deuda, mes, dia });
            });
            
            const miscelaneosElements = document.querySelectorAll('#miscelaneos-container .gasto-item');
            miscelaneosElements.forEach(miscEl => {
                const nombre = miscEl.querySelector('.miscelaneo-nombre-input')?.value || '';
                const monto = miscEl.querySelector('.miscelaneo-monto')?.value || '';
                if (nombre || monto) datos.miscelaneos.push({ nombre, monto });
            });
            
            const imprevistosElements = document.querySelectorAll('#imprevistos-container .gasto-item');
            imprevistosElements.forEach(impEl => {
                const nombre = impEl.querySelector('.imprevisto-nombre-input')?.value || '';
                const monto = impEl.querySelector('.imprevisto-monto')?.value || '';
                const mes = impEl.querySelector('.imprevisto-mes')?.value || '';
                const dia = impEl.querySelector('.imprevisto-dia')?.value || '';
                if (nombre || monto) datos.imprevistos.push({ nombre, monto, mes, dia });
            });
            
            localStorage.setItem('presupuesto_' + presupuestoActual, JSON.stringify(datos));
        }
        
        function cargarPresupuesto() {
            const datosJSON = localStorage.getItem('presupuesto_' + presupuestoActual);
            if (!datosJSON) {
                limpiarFormulario();
                return;
            }
            
            const datos = JSON.parse(datosJSON);
            
            if (document.getElementById('balance-actual')) document.getElementById('balance-actual').value = datos.balanceActual || '';
            if (document.getElementById('meta-ahorro')) document.getElementById('meta-ahorro').value = datos.metaAhorro || '';
            if (document.getElementById('meta-total')) document.getElementById('meta-total').value = datos.metaTotal || '';
            if (document.getElementById('fecha-objetivo')) document.getElementById('fecha-objetivo').value = datos.fechaObjetivo || '';
            
            if (datos.tipoPago) {
                const radioButton = document.querySelector(`input[name="tipo-pago"][value="${datos.tipoPago}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    cambiarTipoPago(datos.tipoPago);
                }
            }
            
            if (document.getElementById('mes-pago1')) document.getElementById('mes-pago1').value = datos.mesPago1 || '';
            if (document.getElementById('dia-pago1')) document.getElementById('dia-pago1').value = datos.diaPago1 || '';
            if (document.getElementById('monto-pago1')) document.getElementById('monto-pago1').value = datos.montoPago1 || '';
            if (document.getElementById('mes-pago2')) document.getElementById('mes-pago2').value = datos.mesPago2 || '';
            if (document.getElementById('dia-pago2')) document.getElementById('dia-pago2').value = datos.diaPago2 || '';
            if (document.getElementById('monto-pago2')) document.getElementById('monto-pago2').value = datos.montoPago2 || '';
            if (document.getElementById('mes-pago3')) document.getElementById('mes-pago3').value = datos.mesPago3 || '';
            if (document.getElementById('dia-pago3')) document.getElementById('dia-pago3').value = datos.diaPago3 || '';
            if (document.getElementById('monto-pago3')) document.getElementById('monto-pago3').value = datos.montoPago3 || '';
            if (document.getElementById('mes-pago4')) document.getElementById('mes-pago4').value = datos.mesPago4 || '';
            if (document.getElementById('dia-pago4')) document.getElementById('dia-pago4').value = datos.diaPago4 || '';
            if (document.getElementById('monto-pago4')) document.getElementById('monto-pago4').value = datos.montoPago4 || '';
            
            if (document.getElementById('gasto-gasolina')) document.getElementById('gasto-gasolina').value = datos.gastoGasolina || '';
            if (document.getElementById('gasto-comida')) document.getElementById('gasto-comida').value = datos.gastoComida || '';
            
            const tbody = document.getElementById('tabla-gastos-fijos-body');
            if (tbody) {
                tbody.innerHTML = '';
                datos.gastosFijos.forEach(gasto => {
                    agregarFilaGastoFijo();
                    const ultimaFila = tbody.lastElementChild;
                    if (ultimaFila) {
                        if (ultimaFila.querySelector('.gasto-fijo-nombre')) ultimaFila.querySelector('.gasto-fijo-nombre').value = gasto.nombre;
                        if (ultimaFila.querySelector('.gasto-fijo-monto')) ultimaFila.querySelector('.gasto-fijo-monto').value = gasto.monto;
                        if (ultimaFila.querySelector('.gasto-fijo-dia')) ultimaFila.querySelector('.gasto-fijo-dia').value = gasto.dia;
                        if (ultimaFila.querySelector('.gasto-fijo-mes')) ultimaFila.querySelector('.gasto-fijo-mes').value = gasto.mes;
                        if (ultimaFila.querySelector('.gasto-fijo-recurrencia')) ultimaFila.querySelector('.gasto-fijo-recurrencia').value = gasto.recurrencia;
                    }
                });
                if (datos.gastosFijos.length === 0) agregarFilaGastoFijo();
            }
            
            const tarjetasContainer = document.getElementById('tarjetas-container');
            if (tarjetasContainer) {
                tarjetasContainer.innerHTML = '';
                datos.tarjetas.forEach(tarjeta => {
                    agregarTarjeta();
                    const ultimaTarjeta = tarjetasContainer.lastElementChild;
                    if (ultimaTarjeta) {
                        if (ultimaTarjeta.querySelector('.tarjeta-nombre')) ultimaTarjeta.querySelector('.tarjeta-nombre').value = tarjeta.nombre;
                        if (ultimaTarjeta.querySelector('.tarjeta-minimo')) ultimaTarjeta.querySelector('.tarjeta-minimo').value = tarjeta.minimo;
                        if (ultimaTarjeta.querySelector('.tarjeta-deuda')) ultimaTarjeta.querySelector('.tarjeta-deuda').value = tarjeta.deuda;
                        if (ultimaTarjeta.querySelector('.tarjeta-mes')) ultimaTarjeta.querySelector('.tarjeta-mes').value = tarjeta.mes;
                        if (ultimaTarjeta.querySelector('.tarjeta-dia')) ultimaTarjeta.querySelector('.tarjeta-dia').value = tarjeta.dia;
                    }
                });
            }
            
            const miscelaneosContainer = document.getElementById('miscelaneos-container');
            if (miscelaneosContainer) {
                miscelaneosContainer.innerHTML = '';
                datos.miscelaneos.forEach(misc => {
                    agregarMiscelaneo();
                    const ultimoMisc = miscelaneosContainer.lastElementChild;
                    if (ultimoMisc) {
                        if (ultimoMisc.querySelector('.miscelaneo-nombre-input')) ultimoMisc.querySelector('.miscelaneo-nombre-input').value = misc.nombre;
                        if (ultimoMisc.querySelector('.miscelaneo-monto')) ultimoMisc.querySelector('.miscelaneo-monto').value = misc.monto;
                    }
                });
            }
            
            const imprevistosContainer = document.getElementById('imprevistos-container');
            if (imprevistosContainer) {
                imprevistosContainer.innerHTML = '';
                datos.imprevistos.forEach(imp => {
                    agregarImprevisto();
                    const ultimoImp = imprevistosContainer.lastElementChild;
                    if (ultimoImp) {
                        if (ultimoImp.querySelector('.imprevisto-nombre-input')) ultimoImp.querySelector('.imprevisto-nombre-input').value = imp.nombre;
                        if (ultimoImp.querySelector('.imprevisto-monto')) ultimoImp.querySelector('.imprevisto-monto').value = imp.monto;
                        if (ultimoImp.querySelector('.imprevisto-mes')) ultimoImp.querySelector('.imprevisto-mes').value = imp.mes;
                        if (ultimoImp.querySelector('.imprevisto-dia')) ultimoImp.querySelector('.imprevisto-dia').value = imp.dia;
                    }
                });
            }
        }
        
        function limpiarFormulario() {
            const inputs = document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"]');
            inputs.forEach(input => input.value = '');
            
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.id !== 'presupuesto-selector') select.selectedIndex = 0;
            });
            
            if (document.getElementById('tabla-gastos-fijos-body')) {
                document.getElementById('tabla-gastos-fijos-body').innerHTML = '';
                agregarFilaGastoFijo();
            }
            if (document.getElementById('tarjetas-container')) document.getElementById('tarjetas-container').innerHTML = '';
            if (document.getElementById('miscelaneos-container')) document.getElementById('miscelaneos-container').innerHTML = '';
            if (document.getElementById('imprevistos-container')) document.getElementById('imprevistos-container').innerHTML = '';
            if (document.getElementById('resultado')) document.getElementById('resultado').innerHTML = '';
        }
        
        function limpiarTodo() {
            if (!confirm('游빛 쮼st치s seguro de limpiar TODOS los datos del formulario?\n\n丘멆잺 Esta acci칩n borrar치:\n Todos los ingresos\n Todos los gastos fijos\n Todas las tarjetas\n Todos los miscel치neos\n Todos los imprevistos\n Los resultados calculados\n\nEl presupuesto actual se guardar치 vac칤o.')) {
                return;
            }
            
            // Limpiar todos los inputs
            const inputs = document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"]');
            inputs.forEach(input => {
                if (input.id !== 'presupuesto-selector') {
                    input.value = '';
                }
            });
            
            // Resetear selects (excepto presupuesto-selector)
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.id !== 'presupuesto-selector') {
                    select.selectedIndex = 0;
                }
            });
            
            // Resetear radios a quincenal
            const radioQuincenal = document.querySelector('input[name="tipo-pago"][value="quincenal"]');
            if (radioQuincenal) {
                radioQuincenal.checked = true;
                cambiarTipoPago('quincenal');
            }
            
            const radioMensual = document.querySelector('input[name="tipo-ahorro"][value="mensual"]');
            if (radioMensual) {
                radioMensual.checked = true;
                cambiarTipoAhorro('mensual');
            }
            
            // Limpiar tabla de gastos fijos
            const tbody = document.getElementById('tabla-gastos-fijos-body');
            if (tbody) {
                tbody.innerHTML = '';
                agregarFilaGastoFijo();
            }
            
            // Limpiar tarjetas
            const tarjetasContainer = document.getElementById('tarjetas-container');
            if (tarjetasContainer) tarjetasContainer.innerHTML = '';
            
            // Limpiar miscel치neos
            const miscelaneosContainer = document.getElementById('miscelaneos-container');
            if (miscelaneosContainer) miscelaneosContainer.innerHTML = '';
            
            // Limpiar imprevistos
            const imprevistosContainer = document.getElementById('imprevistos-container');
            if (imprevistosContainer) imprevistosContainer.innerHTML = '';
            
            // Limpiar resultados
            const resultado = document.getElementById('resultado');
            if (resultado) {
                resultado.innerHTML = '';
                resultado.classList.remove('show');
            }
            
            // Ocultar mensajes de error/칠xito
            const errorContainer = document.getElementById('error-container');
            const successContainer = document.getElementById('success-container');
            if (errorContainer) errorContainer.classList.remove('show');
            if (successContainer) successContainer.classList.remove('show');
            
            // Guardar estado vac칤o
            guardarPresupuesto();
            mostrarMensajeAutoguardado();
            
            // Scroll al inicio
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Mostrar confirmaci칩n
            setTimeout(() => {
                alert('九 Formulario limpiado correctamente.\n\nTodos los datos han sido borrados y el presupuesto actual est치 vac칤o.');
            }, 300);
        }
        
        function programarAutoguardado() {
            if (autoguardadoTimeout) clearTimeout(autoguardadoTimeout);
            autoguardadoTimeout = setTimeout(() => {
                guardarPresupuesto();
                mostrarMensajeAutoguardado();
            }, 1000);
        }
        
        function mostrarMensajeAutoguardado() {
            const indicator = document.getElementById('autosave-indicator');
            if (indicator) {
                indicator.style.opacity = '1';
                setTimeout(() => indicator.style.opacity = '0', 2000);
            }
        }
        
        function activarAutoguardado() {
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    programarAutoguardado();
                }
            });
            
            const observer = new MutationObserver(() => programarAutoguardado());
            ['tabla-gastos-fijos-body', 'tarjetas-container', 'miscelaneos-container', 'imprevistos-container'].forEach(id => {
                const container = document.getElementById(id);
                if (container) observer.observe(container, { childList: true });
            });
        }
        
        // ==================== FIN FUNCIONES DE PRESUPUESTOS ====================
        

        // Funci칩n para agregar fila a la tabla de gastos fijos
        function agregarFilaGastoFijo() {
            const lista = document.getElementById('tabla-gastos-fijos-body');
            if (!lista) return;

            const row = document.createElement('div');
            row.className = 'gasto-fijo-row';
            row.innerHTML = `
                <div class="gasto-fijo-col gasto-col-nombre">
                    <input type="text" class="gasto-fijo-nombre" placeholder="Ej: Agua" />
                </div>
                <div class="gasto-fijo-col gasto-col-monto">
                    <input type="number" class="gasto-fijo-monto" min="0" step="0.01" placeholder="45.00" />
                </div>
                <div class="gasto-fijo-col gasto-col-dia">
                    <input type="number" class="gasto-fijo-dia" min="1" max="31" placeholder="15" />
                </div>
                <div class="gasto-fijo-col gasto-col-mes">
                    <select class="gasto-fijo-mes">
                        <option value="todos" selected>Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="gasto-fijo-col gasto-col-recurrencia">
                    <select class="gasto-fijo-recurrencia">
                        <option value="mensual" selected>Mensual</option>
                        <option value="unico">Pago 칔nico</option>
                    </select>
                </div>
                <div class="gasto-fijo-col gasto-col-acciones gasto-fijo-acciones">
                    <button class="btn-copiar-fila" onclick="copiarFilaGastoFijo(this)" title="Copiar fila">游늶</button>
                    <button class="btn-eliminar-fila" onclick="eliminarFilaGastoFijo(this)" title="Eliminar">游딈勇</button>
                </div>
            `;
            lista.appendChild(row);

            const primerInput = row.querySelector('.gasto-fijo-nombre');
            if (primerInput) setTimeout(() => primerInput.focus(), 100);

            const inputs = row.querySelectorAll('input, select');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && index === inputs.length - 1) {
                        e.preventDefault();
                        agregarFilaGastoFijo();
                    }
                });
            });

            gastoFijoCounter++;
        }
        
        function copiarFilaGastoFijo(btn) {
            const row = btn.closest('.gasto-fijo-row');
            const nombre = row.querySelector('.gasto-fijo-nombre').value;
            const monto = row.querySelector('.gasto-fijo-monto').value;
            const dia = row.querySelector('.gasto-fijo-dia').value;
            const mes = row.querySelector('.gasto-fijo-mes').value;
            const recurrencia = row.querySelector('.gasto-fijo-recurrencia').value;

            agregarFilaGastoFijo();

            const lista = document.getElementById('tabla-gastos-fijos-body');
            const ultimaFila = lista.lastElementChild;
            if (ultimaFila) {
                ultimaFila.querySelector('.gasto-fijo-nombre').value = nombre;
                ultimaFila.querySelector('.gasto-fijo-monto').value = monto;
                ultimaFila.querySelector('.gasto-fijo-dia').value = dia;
                ultimaFila.querySelector('.gasto-fijo-mes').value = mes;
                ultimaFila.querySelector('.gasto-fijo-recurrencia').value = recurrencia;
            }
        }

        function eliminarFilaGastoFijo(btn) {
            const row = btn.closest('.gasto-fijo-row');
            row.remove();
        }
        
        function ordenarTablaGastosFijos(columna) {
            const lista = document.getElementById('tabla-gastos-fijos-body');
            const filas = Array.from(lista.querySelectorAll('.gasto-fijo-row'));
            
            filas.sort((a, b) => {
                let valorA, valorB;
                
                if (columna === 'nombre') {
                    valorA = a.querySelector('.gasto-fijo-nombre').value.toLowerCase();
                    valorB = b.querySelector('.gasto-fijo-nombre').value.toLowerCase();
                    return valorA.localeCompare(valorB);
                } else if (columna === 'monto') {
                    valorA = parseFloat(a.querySelector('.gasto-fijo-monto').value) || 0;
                    valorB = parseFloat(b.querySelector('.gasto-fijo-monto').value) || 0;
                    return valorA - valorB;
                } else if (columna === 'dia') {
                    valorA = parseInt(a.querySelector('.gasto-fijo-dia').value) || 0;
                    valorB = parseInt(b.querySelector('.gasto-fijo-dia').value) || 0;
                    return valorA - valorB;
                }
                
                return 0;
            });
            
            lista.innerHTML = '';
            filas.forEach(fila => lista.appendChild(fila));
        }
        
        // Funci칩n para expandir/colapsar ayuda
        function toggleHelp(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        let imprevistoCounter = 0;
        
        // ==================== FUNCIONES DE AHORRO CON FECHA ====================
        
        function cambiarTipoAhorro(tipo) {
            const mensualDiv = document.getElementById('ahorro-mensual');
            const fechaDiv = document.getElementById('ahorro-fecha');
            const metaAhorroInput = document.getElementById('meta-ahorro');
            
            if (tipo === 'mensual') {
                mensualDiv.style.display = 'block';
                fechaDiv.style.display = 'none';
                document.getElementById('resultado-calculo').style.display = 'none';
            } else {
                mensualDiv.style.display = 'none';
                fechaDiv.style.display = 'block';
                metaAhorroInput.value = 0; // Resetear meta mensual
            }
        }
        
        // Funci칩n para cambiar entre Quincenal y Semanal
        function cambiarTipoPago(tipo) {
            const paychecksSemanales = document.getElementById('paychecks-semanales');
            
            if (tipo === 'semanal') {
                paychecksSemanales.style.display = 'block';
            } else {
                paychecksSemanales.style.display = 'none';
            }
        }
        
        function calcularAhorroMensual() {
            // Esta funci칩n se llama cuando cambia el input de ahorro mensual
            // No hace nada especial, solo est치 para consistencia
        }
        
        function calcularAhorroConFecha() {
            const metaTotal = parseFloat(document.getElementById('meta-total').value) || 0;
            const fechaObjetivo = document.getElementById('fecha-objetivo').value;
            const resultadoDiv = document.getElementById('resultado-calculo');
            const infoDiv = document.getElementById('info-calculo');
            const metaAhorroInput = document.getElementById('meta-ahorro');
            
            if (metaTotal <= 0 || !fechaObjetivo) {
                resultadoDiv.style.display = 'none';
                metaAhorroInput.value = 0;
                return;
            }
            
            // Calcular meses y d칤as hasta la fecha objetivo
            const hoy = new Date();
            const objetivo = new Date(fechaObjetivo);
            
            // Validar que la fecha sea futura
            if (objetivo <= hoy) {
                infoDiv.innerHTML = '<div style="color: #d32f2f;">丘멆잺 La fecha debe ser futura</div>';
                resultadoDiv.style.display = 'block';
                metaAhorroInput.value = 0;
                return;
            }
            
            // Calcular diferencia en milisegundos
            const diferenciaMilisegundos = objetivo - hoy;
            const diferenciaDias = Math.ceil(diferenciaMilisegundos / (1000 * 60 * 60 * 24));
            const diferenciaMeses = Math.ceil(diferenciaDias / 30);
            
            // Calcular cu치nto ahorrar por mes y por paycheck
            const ahorroPorMes = metaTotal / diferenciaMeses;
            const ahorroPorPaycheck = ahorroPorMes / 2;
            
            // Actualizar el input de meta-ahorro con el c치lculo
            metaAhorroInput.value = ahorroPorMes.toFixed(2);
            
            // Formatear fecha objetivo
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const fechaFormateada = `${objetivo.getDate()} de ${meses[objetivo.getMonth()]} ${objetivo.getFullYear()}`;
            
            // Mostrar resultado
            infoDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                    游딉勇 <strong>Tiempo disponible:</strong> ${diferenciaMeses} meses (${diferenciaDias} d칤as)
                </div>
                <div style="margin-bottom: 8px;">
                    游늰 <strong>Fecha objetivo:</strong> ${fechaFormateada}
                </div>
                <div style="margin-bottom: 8px;">
                    游눯 <strong>Meta total:</strong> $${metaTotal.toFixed(2)}
                </div>
                <hr style="border: none; border-top: 1px solid #a5d6a7; margin: 10px 0;">
                <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <div style="font-size: 1.1em; color: #2e7d32; margin-bottom: 5px;">
                        <strong>Debes ahorrar por mes:</strong> <span style="font-size: 1.3em;">$${ahorroPorMes.toFixed(2)}</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        O $${ahorroPorPaycheck.toFixed(2)} por cada PayCheck
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fff9c4; border-radius: 5px; font-size: 0.85em; color: #f57f17;">
                    游눠 <strong>Consejo:</strong> Este monto se aplicar치 autom치ticamente al calcular tu plan financiero.
                </div>
            `;
            
            resultadoDiv.style.display = 'block';
        }
        
        // ==================== FIN FUNCIONES DE AHORRO ====================
        
        function agregarImprevisto(nombrePredefinido = '') {
            imprevistoCounter++;
            const container = document.getElementById('imprevistos-container');
            const imprevistoDiv = document.createElement('div');
            imprevistoDiv.className = 'gasto-item';
            imprevistoDiv.style.borderColor = '#ff6b6b';
            imprevistoDiv.id = `imprevisto-${imprevistoCounter}`;
            
            imprevistoDiv.innerHTML = `
                <div class="gasto-header">
                    <input type="text" class="imprevisto-nombre-input" placeholder="Ej: Cumplea침os de mam치, Viaje, Reparaci칩n carro" value="${nombrePredefinido}" style="border: none; font-weight: bold; color: #ff6b6b; font-size: 1.1em; background: transparent; width: 60%;">
                    <button class="btn-remove" onclick="removerImprevisto(${imprevistoCounter})" style="background: #ff6b6b; color: white;">九 Eliminar</button>
                </div>
                <div class="input-group">
    <label>游눶 Monto total ($)</label>
    <input type="number" class="imprevisto-monto" min="0" step="0.01" placeholder="0.00">
</div>
<div class="row">
    <div class="input-group">
        <label>游늰 Mes</label>
        <select class="imprevisto-mes" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>
    <div class="input-group">
        <label>游늰 D칤a (1-31)</label>
        <input type="number" class="imprevisto-dia" min="1" max="31" placeholder="15">
    </div>
</div>
            `;
            
            container.appendChild(imprevistoDiv);
        }
        

        function agregarTarjeta(nombrePredefinido = '') {
            tarjetaCounter++;
            const container = document.getElementById('tarjetas-container');
            const tarjetaDiv = document.createElement('div');
            tarjetaDiv.className = 'gasto-categoria';
            tarjetaDiv.id = `tarjeta-${tarjetaCounter}`;
            
            tarjetaDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <input type="text" class="tarjeta-nombre" placeholder="Visa" value="${nombrePredefinido}" 
                        style="border: none; font-weight: bold; color: #667eea; font-size: 1.1em; background: transparent; flex: 1;">
                    <button class="btn-remove" onclick="removerTarjeta(${tarjetaCounter})" 
                        style="background: #667eea; color: white; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                        九 Eliminar
                    </button>
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>Pago m칤nimo</label>
                        <input type="number" class="tarjeta-minimo" min="0" step="0.01" placeholder="50.00">
                        <small style="color: #999;">Lo m칤nimo que pide la tarjeta</small>
                    </div>
                    <div class="input-group">
                        <label>Cu치nto debes en total</label>
                        <input type="number" class="tarjeta-deuda" min="0" step="0.01" placeholder="1500.00">
                    </div>
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>Mes</label>
                        <select class="tarjeta-mes" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                            <option value="todos" selected>Todos los meses</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>D칤a que vence</label>
                        <input type="number" class="tarjeta-dia" min="1" max="31" placeholder="15">
                    </div>
                </div>
            `;
            
            container.appendChild(tarjetaDiv);
        }
        
        function removerTarjeta(id) {
            const tarjeta = document.getElementById(`tarjeta-${id}`);
            if (tarjeta) tarjeta.remove();
        }
        
        function removerImprevisto(id) {
            const imprevisto = document.getElementById(`imprevisto-${id}`);
            if (imprevisto) {
                imprevisto.remove();
            }
        }
        
        function agregarGasto(nombrePredefinido = '') {
            gastoCounter++;
            const container = document.getElementById('gastos-container');
            const gastoDiv = document.createElement('div');
            gastoDiv.className = 'gasto-item';
            gastoDiv.id = `gasto-${gastoCounter}`;
            
            gastoDiv.innerHTML = `
                <div class="gasto-header">
                    <input type="text" class="gasto-nombre-input" placeholder="Nombre del gasto" value="${nombrePredefinido}" style="border: none; font-weight: bold; color: #667eea; font-size: 1.1em; background: transparent; width: 60%;">
                    <button class="btn-remove" onclick="removerGasto(${gastoCounter})">九 Eliminar</button>
                </div>
                <div class="input-group">
                    <label>Monto mensual ($)</label>
                    <input type="number" class="gasto-monto" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>D칤a de vencimiento (1-31)</label>
                        <input type="number" class="gasto-dia" min="1" max="31" placeholder="15">
                    </div>
                    <div class="input-group">
                        <label>Mes (opcional)</label>
                        <select class="gasto-mes" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; background: white;">
                            <option value="todos">Todos los meses</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(gastoDiv);
        }
        
        function agregarMiscelaneo(nombrePredefinido = '') {
            miscelaneoCounter++;
            const container = document.getElementById('miscelaneos-container');
            const miscelaneoDiv = document.createElement('div');
            miscelaneoDiv.className = 'gasto-item';
            miscelaneoDiv.style.borderColor = '#ffd43b';
            miscelaneoDiv.id = `miscelaneo-${miscelaneoCounter}`;
            
            miscelaneoDiv.innerHTML = `
                <div class="gasto-header">
                    <input type="text" class="miscelaneo-nombre-input" placeholder="Nombre del gasto miscel치neo" value="${nombrePredefinido}" style="border: none; font-weight: bold; color: #f59f00; font-size: 1.1em; background: transparent; width: 60%;">
                    <button class="btn-remove" onclick="removerMiscelaneo(${miscelaneoCounter})" style="background: #ffd43b; color: #333;">九 Eliminar</button>
                </div>
                <div class="input-group">
                    <label>Presupuesto mensual estimado ($)</label>
                    <input type="number" class="miscelaneo-monto" min="0" step="0.01" placeholder="0.00">
                </div>
            `;
            
            container.appendChild(miscelaneoDiv);
        }
        
        function removerGasto(id) {
            const gasto = document.getElementById(`gasto-${id}`);
            if (gasto) {
                gasto.remove();
            }
        }
        
        function removerMiscelaneo(id) {
            const miscelaneo = document.getElementById(`miscelaneo-${id}`);
            if (miscelaneo) {
                miscelaneo.remove();
            }
        }
        
        // ==================== FUNCIONES DE VALIDACI칍N ====================
        
        function mostrarError(mensajes) {
            const errorContainer = document.getElementById('error-container');
            const errorList = document.getElementById('error-list');
            const successContainer = document.getElementById('success-container');
            
            // Ocultar mensaje de 칠xito
            successContainer.classList.remove('show');
            
            // Limpiar lista anterior
            errorList.innerHTML = '';
            
            // Agregar cada mensaje
            mensajes.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                errorList.appendChild(li);
            });
            
            // Mostrar error
            errorContainer.classList.add('show');
            
            // Scroll al error
            errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Ocultar despu칠s de 5 segundos
            setTimeout(() => {
                errorContainer.classList.remove('show');
            }, 5000);
        }
        
        function mostrarExito() {
            const errorContainer = document.getElementById('error-container');
            const successContainer = document.getElementById('success-container');
            
            // Ocultar errores
            errorContainer.classList.remove('show');
            
            // Mostrar 칠xito
            successContainer.classList.add('show');
            
            // Ocultar despu칠s de 3 segundos
            setTimeout(() => {
                successContainer.classList.remove('show');
            }, 3000);
        }
        
        function marcarCampoError(elemento) {
            if (elemento) {
                elemento.classList.add('input-error');
                setTimeout(() => {
                    elemento.classList.remove('input-error');
                }, 3000);
            }
        }
        
        function validarDatos() {
            const errores = [];
            
            // Validar PayCheck 1
            const diaPago1 = parseInt(document.getElementById('dia-pago1').value);
            const montoPago1 = parseFloat(document.getElementById('monto-pago1').value);
            
            if (!diaPago1) {
                errores.push('D칤a de PayCheck 1 es requerido');
                marcarCampoError(document.getElementById('dia-pago1'));
            } else if (diaPago1 < 1 || diaPago1 > 31) {
                errores.push('D칤a de PayCheck 1 debe estar entre 1 y 31');
                marcarCampoError(document.getElementById('dia-pago1'));
            }
            
            if (!montoPago1 || montoPago1 <= 0) {
                errores.push('Monto de PayCheck 1 debe ser mayor a 0');
                marcarCampoError(document.getElementById('monto-pago1'));
            }
            
            // Validar PayCheck 2
            const diaPago2 = parseInt(document.getElementById('dia-pago2').value);
            const montoPago2 = parseFloat(document.getElementById('monto-pago2').value);
            
            if (!diaPago2) {
                errores.push('D칤a de PayCheck 2 es requerido');
                marcarCampoError(document.getElementById('dia-pago2'));
            } else if (diaPago2 < 1 || diaPago2 > 31) {
                errores.push('D칤a de PayCheck 2 debe estar entre 1 y 31');
                marcarCampoError(document.getElementById('dia-pago2'));
            }
            
            if (!montoPago2 || montoPago2 <= 0) {
                errores.push('Monto de PayCheck 2 debe ser mayor a 0');
                marcarCampoError(document.getElementById('monto-pago2'));
            }
            
            // Validar Balance Actual (si existe)
            const balanceActual = parseFloat(document.getElementById('balance-actual').value) || 0;
            if (balanceActual < 0) {
                errores.push('Balance actual no puede ser negativo');
                marcarCampoError(document.getElementById('balance-actual'));
            }
            
            // Validar Meta de Ahorro (si existe)
            const metaAhorro = parseFloat(document.getElementById('meta-ahorro').value) || 0;
            if (metaAhorro < 0) {
                errores.push('Meta de ahorro no puede ser negativa');
                marcarCampoError(document.getElementById('meta-ahorro'));
            }
            
            // Validar Gastos Fijos (tabla)
            const filasGastosFijos = document.querySelectorAll('#tabla-gastos-fijos-body .gasto-fijo-row');
            let gastosValidos = 0;
            
            filasGastosFijos.forEach((fila, index) => {
                const nombreInput = fila.querySelector('.gasto-fijo-nombre');
                const montoInput = fila.querySelector('.gasto-fijo-monto');
                const diaInput = fila.querySelector('.gasto-fijo-dia');
                
                const nombre = nombreInput.value.trim();
                const monto = parseFloat(montoInput.value) || 0;
                const dia = parseInt(diaInput.value) || 0;
                
                // Solo validar si tiene alg칰n dato
                if (nombre || monto > 0 || dia > 0) {
                    if (!nombre) {
                        errores.push(`Gasto fijo ${index + 1}: Falta el nombre`);
                        marcarCampoError(nombreInput);
                    }
                    if (monto <= 0) {
                        errores.push(`Gasto fijo "${nombre || index + 1}": Monto debe ser mayor a 0`);
                        marcarCampoError(montoInput);
                    }
                    if (dia < 1 || dia > 31) {
                        errores.push(`Gasto fijo "${nombre || index + 1}": D칤a debe estar entre 1 y 31`);
                        marcarCampoError(diaInput);
                    }
                    
                    if (nombre && monto > 0 && dia >= 1 && dia <= 31) {
                        gastosValidos++;
                    }
                }
            });
            
            // Validar Tarjetas
            const tarjetasElements = document.querySelectorAll('.tarjeta-nombre');
            tarjetasElements.forEach((tarjetaNombreEl, index) => {
                const nombre = tarjetaNombreEl.value.trim();
                const contenedor = tarjetaNombreEl.closest('.gasto-categoria');
                const minimoInput = contenedor.querySelector('.tarjeta-minimo');
                const deudaInput = contenedor.querySelector('.tarjeta-deuda');
                const diaInput = contenedor.querySelector('.tarjeta-dia');
                
                const minimo = parseFloat(minimoInput.value) || 0;
                const deuda = parseFloat(deudaInput.value) || 0;
                const dia = parseInt(diaInput.value) || 0;
                
                // Solo validar si tiene alg칰n dato
                if (nombre || minimo > 0 || deuda > 0 || dia > 0) {
                    if (!nombre) {
                        errores.push(`Tarjeta ${index + 1}: Falta el nombre`);
                        marcarCampoError(tarjetaNombreEl);
                    }
                    if (minimo <= 0) {
                        errores.push(`Tarjeta "${nombre || index + 1}": Pago m칤nimo debe ser mayor a 0`);
                        marcarCampoError(minimoInput);
                    }
                    if (deuda <= 0) {
                        errores.push(`Tarjeta "${nombre || index + 1}": Balance debe ser mayor a 0`);
                        marcarCampoError(deudaInput);
                    }
                    if (dia < 1 || dia > 31) {
                        errores.push(`Tarjeta "${nombre || index + 1}": D칤a debe estar entre 1 y 31`);
                        marcarCampoError(diaInput);
                    }
                }
            });
            
            // Validar Imprevistos
            const imprevistosElementsVal = document.querySelectorAll('#imprevistos-container .gasto-item');
            imprevistosElementsVal.forEach((contenedor, index) => {
                const nombreEl = contenedor.querySelector('.imprevisto-nombre-input');
                const montoInput = contenedor.querySelector('.imprevisto-monto');
                const diaInput = contenedor.querySelector('.imprevisto-dia');
                
                if (!nombreEl || !montoInput || !diaInput) return;
                
                const nombre = nombreEl.value.trim();
                const monto = parseFloat(montoInput.value) || 0;
                const dia = parseInt(diaInput.value) || 0;
                
                // Solo validar si tiene alg칰n dato
                if (nombre || monto > 0 || dia > 0) {
                    if (!nombre) {
                        errores.push(`Imprevisto ${index + 1}: Falta el nombre`);
                        marcarCampoError(nombreEl);
                    }
                    if (monto <= 0) {
                        errores.push(`Imprevisto "${nombre || index + 1}": Monto debe ser mayor a 0`);
                        marcarCampoError(montoInput);
                    }
                    if (dia < 1 || dia > 31) {
                        errores.push(`Imprevisto "${nombre || index + 1}": D칤a debe estar entre 1 y 31`);
                        marcarCampoError(diaInput);
                    }
                }
            });
            
            return errores;
        }
        
        // ==================== FIN FUNCIONES DE VALIDACI칍N ====================
        
        function calcularFinanzas() {
            // Limpiar mensajes anteriores
            document.getElementById('error-container').classList.remove('show');
            document.getElementById('success-container').classList.remove('show');
            
            // VALIDAR PRIMERO
            const errores = validarDatos();
            if (errores.length > 0) {
                mostrarError(errores);
                return; // No continuar si hay errores
            }
            
            // Mostrar mensaje de 칠xito breve
            mostrarExito();
            
            try {
            // Obtener ingresos
            const mesPago1 = parseInt(document.getElementById('mes-pago1').value) || 0;
            const diaPago1 = parseInt(document.getElementById('dia-pago1').value) || 0;
            const montoPago1 = parseFloat(document.getElementById('monto-pago1').value) || 0;
            const mesPago2 = parseInt(document.getElementById('mes-pago2').value) || 0;
            const diaPago2 = parseInt(document.getElementById('dia-pago2').value) || 0;
            const montoPago2 = parseFloat(document.getElementById('monto-pago2').value) || 0;
            
            // Verificar si est치 en modo semanal
            const tipoPago = document.querySelector('input[name="tipo-pago"]:checked').value;
            const esSemanal = tipoPago === 'semanal';
            
            let mesPago3 = 0, diaPago3 = 0, montoPago3 = 0;
            let mesPago4 = 0, diaPago4 = 0, montoPago4 = 0;
            
            if (esSemanal) {
                mesPago3 = parseInt(document.getElementById('mes-pago3').value) || 0;
                diaPago3 = parseInt(document.getElementById('dia-pago3').value) || 0;
                montoPago3 = parseFloat(document.getElementById('monto-pago3').value) || 0;
                mesPago4 = parseInt(document.getElementById('mes-pago4').value) || 0;
                diaPago4 = parseInt(document.getElementById('dia-pago4').value) || 0;
                montoPago4 = parseFloat(document.getElementById('monto-pago4').value) || 0;
            }
            
            // Obtener balance actual y meta de ahorro
            const balanceActual = parseFloat(document.getElementById('balance-actual').value) || 0;
            const metaAhorro = parseFloat(document.getElementById('meta-ahorro').value) || 0;
            
            if (!diaPago1 || !montoPago1 || !diaPago2 || !montoPago2) {
                alert('丘멆잺 Por favor completa todos los datos de ingresos');
                return;
            }
            
            if (esSemanal && (!diaPago3 || !montoPago3 || !diaPago4 || !montoPago4)) {
                alert('丘멆잺 En modo semanal debes completar los 4 PayChecks');
                return;
            }
            
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const totalIngresos = esSemanal ? (montoPago1 + montoPago2 + montoPago3 + montoPago4) : (montoPago1 + montoPago2);
            
            // Obtener gastos fijos de la TABLA COMPACTA
            const filasGastosFijos = document.querySelectorAll('#tabla-gastos-fijos-body .gasto-fijo-row');
            const gastos = [];
            let totalGastos = 0;
            
            filasGastosFijos.forEach(fila => {
                const nombreInput = fila.querySelector('.gasto-fijo-nombre');
                const montoInput = fila.querySelector('.gasto-fijo-monto');
                const diaInput = fila.querySelector('.gasto-fijo-dia');
                const mesSelect = fila.querySelector('.gasto-fijo-mes');
                
                if (nombreInput && montoInput && diaInput && mesSelect) {
                    const nombre = nombreInput.value.trim();
                    const monto = parseFloat(montoInput.value) || 0;
                    const dia = parseInt(diaInput.value) || 0;
                    const mes = mesSelect.value;
                    
                    if (nombre && monto > 0 && dia > 0) {
                        gastos.push({ nombre, monto, dia, mes, tipo: 'servicio' });
                        totalGastos += monto;
                    }
                }
            });
            
            // Obtener gastos sin d칤a espec칤fico (gasolina, comida)
            const serviciosSinDiaElements = document.querySelectorAll('.servicio-monto-sin-dia');
            serviciosSinDiaElements.forEach(servicioEl => {
                const nombre = servicioEl.getAttribute('data-nombre');
                const monto = parseFloat(servicioEl.value) || 0;
                
                if (monto > 0) {
                    // Dividir entre los dos pagos y asignarlos correctamente
                    const montoPorPago = monto / 2;
                    // Primer pago recibe la primera mitad
                    gastos.push({ nombre: nombre + ' (1ra quincena)', monto: montoPorPago, dia: diaPago1 + 1, tipo: 'variable', esPrimerPago: true });
                    // Segundo pago recibe la segunda mitad
                    gastos.push({ nombre: nombre + ' (2da quincena)', monto: montoPorPago, dia: diaPago2 + 1, tipo: 'variable', esPrimerPago: false });
                    totalGastos += monto;
                }
            });
            
            // Obtener tarjetas de cr칠dito (pago m칤nimo y deuda total)
            const tarjetasElements = document.querySelectorAll('.tarjeta-nombre');
            const tarjetas = [];
            let totalMinimosTarjetas = 0;
            let totalDeudasTarjetas = 0;
            
            tarjetasElements.forEach(tarjetaEl => {
                const contenedor = tarjetaEl.closest('.gasto-categoria');
                const nombre = tarjetaEl.value || 'Tarjeta';
                const minimo = parseFloat(contenedor.querySelector('.tarjeta-minimo').value) || 0;
                const deuda = parseFloat(contenedor.querySelector('.tarjeta-deuda').value) || 0;
                const dia = parseInt(contenedor.querySelector('.tarjeta-dia').value) || 0;
                const mesSelect = contenedor.querySelector('.tarjeta-mes');
                const mes = mesSelect ? mesSelect.value : 'todos';
                
                if (minimo > 0 && dia > 0) {
                    tarjetas.push({ nombre, minimo, deuda, dia, mes, tipo: 'tarjeta' });
                    totalMinimosTarjetas += minimo;
                    totalDeudasTarjetas += deuda;
                }
            });
            
            // Obtener gastos adicionales personalizados
            const gastosElements = document.querySelectorAll('#gastos-container .gasto-item');
            
            gastosElements.forEach(gastoEl => {
                const nombreInput = gastoEl.querySelector('.gasto-nombre-input');
                const montoInput = gastoEl.querySelector('.gasto-monto');
                const diaInput = gastoEl.querySelector('.gasto-dia');
                const mesSelect = gastoEl.querySelector('.gasto-mes');
                
                if (nombreInput && montoInput && diaInput) {
                    const nombre = nombreInput.value || 'Sin nombre';
                    const monto = parseFloat(montoInput.value) || 0;
                    const dia = parseInt(diaInput.value) || 0;
                    const mes = mesSelect ? mesSelect.value : 'todos';
                    
                    if (monto > 0 && dia > 0) {
                        gastos.push({ nombre, monto, dia, mes, tipo: 'personalizado' });
                        totalGastos += monto;
                    }
                }
            });
            
            // Obtener miscel치neos
            const miscelaneosElements = document.querySelectorAll('#miscelaneos-container .gasto-item');
            const miscelaneos = [];
            let totalMiscelaneos = 0;
            
            miscelaneosElements.forEach(miscEl => {
                const nombreInput = miscEl.querySelector('.miscelaneo-nombre-input');
                const montoInput = miscEl.querySelector('.miscelaneo-monto');
                
                if (nombreInput && montoInput) {
                    const nombre = nombreInput.value || 'Sin nombre';
                    const monto = parseFloat(montoInput.value) || 0;
                    
                    if (monto > 0) {
                        miscelaneos.push({ nombre, monto, tipo: 'miscelaneo' });
                        totalMiscelaneos += monto;
                    }
                }
            });
            
            // Obtener gastos imprevistos (solo este mes)
            const imprevistosElements = document.querySelectorAll('#imprevistos-container .gasto-item');
            const imprevistos = [];
            let totalImprevistos = 0;
            
            imprevistosElements.forEach(impEl => {
                const nombreInput = impEl.querySelector('.imprevisto-nombre-input');
                const montoInput = impEl.querySelector('.imprevisto-monto');
                const mesInput = impEl.querySelector('.imprevisto-mes');
                const diaInput = impEl.querySelector('.imprevisto-dia');
                
                if (nombreInput && montoInput && mesInput && diaInput) {
                    const nombre = nombreInput.value || 'Sin nombre';
                    const monto = parseFloat(montoInput.value) || 0;
                    const mes = mesInput.value;
                    const dia = parseInt(diaInput.value) || 0;
                    
                    if (monto > 0 && dia > 0) {
                        imprevistos.push({ nombre, monto, mes, dia, tipo: 'imprevisto' });
                        totalImprevistos += monto;
                    }
                }
            });
            
            
            
            if (gastos.length === 0 && miscelaneos.length === 0 && tarjetas.length === 0 && imprevistos.length === 0) {
                alert('丘멆잺 Por favor agrega al menos un gasto');
                return;
            }
            
            // Calcular gastos urgentes (que vencen antes del PayCheck 1)
            let totalGastosUrgentes = 0;
            if (balanceActual > 0) {
                const hoy = new Date();
                const a침oActual = hoy.getFullYear();
                const fechaPago1 = new Date(a침oActual, mesPago1 - 1, diaPago1);
                
                // Revisar gastos regulares
                gastos.forEach(gasto => {
                    if (gasto.tipo !== 'variable' && gasto.dia) {
                        const mesGasto = (gasto.mes && gasto.mes !== 'todos') ? parseInt(gasto.mes) : mesPago1;
                        const fechaGasto = new Date(a침oActual, mesGasto - 1, gasto.dia);
                        if (fechaGasto < fechaPago1) {
                            totalGastosUrgentes += gasto.monto;
                        }
                    }
                });
                
                // Revisar tarjetas
                tarjetas.forEach(tarjeta => {
                    if (tarjeta.dia) {
                        const mesTarjeta = (tarjeta.mes && tarjeta.mes !== 'todos') ? parseInt(tarjeta.mes) : mesPago1;
                        const fechaTarjeta = new Date(a침oActual, mesTarjeta - 1, tarjeta.dia);
                        if (fechaTarjeta < fechaPago1) {
                            totalGastosUrgentes += tarjeta.minimo;
                        }
                    }
                });
                
                // Revisar imprevistos
                imprevistos.forEach(imprevisto => {
                    if (imprevisto.mes && imprevisto.dia) {
                        const mesImprevisto = parseInt(imprevisto.mes);
                        const fechaImprevisto = new Date(a침oActual, mesImprevisto - 1, imprevisto.dia);
                        if (fechaImprevisto < fechaPago1) {
                            totalGastosUrgentes += imprevisto.monto;
                        }
                    }
                });
            }
            
            const balanceDisponible = balanceActual - totalGastosUrgentes;
            const capitalTotal = totalIngresos + balanceDisponible;
            
            // Organizar gastos por pago (adaptado para quincenal o semanal)
            const gastosPago1 = [];
            const gastosPago2 = [];
            const gastosPago3 = [];
            const gastosPago4 = [];
            
            gastos.forEach(gasto => {
                // Si es un gasto variable, ya sabemos a qu칠 pago pertenece
                if (gasto.tipo === 'variable') {
                    if (gasto.esPrimerPago) {
                        gastosPago1.push(gasto);
                    } else {
                        gastosPago2.push(gasto);
                    }
                } else {
                    // Para otros gastos, determinar cu치l pago viene primero despu칠s del vencimiento
                    const a침oActual = new Date().getFullYear();
                    const fechaPago1 = new Date(a침oActual, mesPago1 - 1, diaPago1);
                    const fechaPago2 = new Date(a침oActual, mesPago2 - 1, diaPago2);
                    
                    const mesGasto = (gasto.mes && gasto.mes !== 'todos') ? parseInt(gasto.mes) : mesPago1;
                    const fechaGasto = new Date(a침oActual, mesGasto - 1, gasto.dia);
                    
                    if (esSemanal) {
                        // Modo semanal: asignar al pago m치s cercano despu칠s del vencimiento
                        const fechaPago3 = new Date(a침oActual, mesPago3 - 1, diaPago3);
                        const fechaPago4 = new Date(a침oActual, mesPago4 - 1, diaPago4);
                        
                        if (fechaGasto <= fechaPago1) {
                            gastosPago1.push(gasto);
                        } else if (fechaGasto <= fechaPago2) {
                            gastosPago2.push(gasto);
                        } else if (fechaGasto <= fechaPago3) {
                            gastosPago3.push(gasto);
                        } else if (fechaGasto <= fechaPago4) {
                            gastosPago4.push(gasto);
                        } else {
                            gastosPago4.push(gasto);
                        }
                    } else {
                        // Modo quincenal (original)
                        if (fechaGasto <= fechaPago1) {
                            gastosPago1.push(gasto);
                        } else if (fechaGasto <= fechaPago2) {
                            gastosPago2.push(gasto);
                        } else {
                            gastosPago2.push(gasto);
                        }
                    }
                }
            });
            
            // Organizar imprevistos por pago
            imprevistos.forEach(imprevisto => {
                const a침oActual = new Date().getFullYear();
                const fechaPago1 = new Date(a침oActual, mesPago1 - 1, diaPago1);
                const fechaPago2 = new Date(a침oActual, mesPago2 - 1, diaPago2);
                
                const mesImprevisto = parseInt(imprevisto.mes);
                const fechaImprevisto = new Date(a침oActual, mesImprevisto - 1, imprevisto.dia);
                
                if (esSemanal) {
                    const fechaPago3 = new Date(a침oActual, mesPago3 - 1, diaPago3);
                    const fechaPago4 = new Date(a침oActual, mesPago4 - 1, diaPago4);
                    
                    if (fechaImprevisto <= fechaPago1) {
                        gastosPago1.push(imprevisto);
                    } else if (fechaImprevisto <= fechaPago2) {
                        gastosPago2.push(imprevisto);
                    } else if (fechaImprevisto <= fechaPago3) {
                        gastosPago3.push(imprevisto);
                    } else if (fechaImprevisto <= fechaPago4) {
                        gastosPago4.push(imprevisto);
                    } else {
                        gastosPago4.push(imprevisto);
                    }
                } else {
                    if (fechaImprevisto <= fechaPago1) {
                        gastosPago1.push(imprevisto);
                    } else if (fechaImprevisto <= fechaPago2) {
                        gastosPago2.push(imprevisto);
                    } else {
                        gastosPago2.push(imprevisto);
                    }
                }
            });
            
            // Dividir miscel치neos entre los pagos
            const numPagos = esSemanal ? 4 : 2;
            const miscelaneosPorPago = totalMiscelaneos / numPagos;
            
            // Calcular totales SIN tarjetas primero
            const totalPago1SinTarjetas = gastosPago1.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago;
            const totalPago2SinTarjetas = gastosPago2.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago;
            const totalPago3SinTarjetas = esSemanal ? (gastosPago3.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago) : 0;
            const totalPago4SinTarjetas = esSemanal ? (gastosPago4.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago) : 0;
            
            // Calcular dinero disponible para tarjetas
            const disponiblePago1 = montoPago1 - totalPago1SinTarjetas;
            const disponiblePago2 = montoPago2 - totalPago2SinTarjetas;
            const disponiblePago3 = esSemanal ? (montoPago3 - totalPago3SinTarjetas) : 0;
            const disponiblePago4 = esSemanal ? (montoPago4 - totalPago4SinTarjetas) : 0;
            
            // Organizar tarjetas por pago
          const tarjetasPago1 = [];
const tarjetasPago2 = [];
const tarjetasPago3 = [];
const tarjetasPago4 = [];

tarjetas.forEach(tarjeta => {
    const a침oActual = new Date().getFullYear();
    const fechaPago1 = new Date(a침oActual, mesPago1 - 1, diaPago1);
    const fechaPago2 = new Date(a침oActual, mesPago2 - 1, diaPago2);
    
    const mesTarjeta = (tarjeta.mes && tarjeta.mes !== 'todos') ? parseInt(tarjeta.mes) : mesPago1;
    const fechaTarjeta = new Date(a침oActual, mesTarjeta - 1, tarjeta.dia);
    
    if (esSemanal) {
        const fechaPago3 = new Date(a침oActual, mesPago3 - 1, diaPago3);
        const fechaPago4 = new Date(a침oActual, mesPago4 - 1, diaPago4);
        
        if (fechaTarjeta <= fechaPago1) {
            tarjetasPago1.push(tarjeta);
        } else if (fechaTarjeta <= fechaPago2) {
            tarjetasPago2.push(tarjeta);
        } else if (fechaTarjeta <= fechaPago3) {
            tarjetasPago3.push(tarjeta);
        } else if (fechaTarjeta <= fechaPago4) {
            tarjetasPago4.push(tarjeta);
        } else {
            tarjetasPago4.push(tarjeta);
        }
    } else {
        if (fechaTarjeta <= fechaPago1) {
            tarjetasPago1.push(tarjeta);
        } else if (fechaTarjeta <= fechaPago2) {
            tarjetasPago2.push(tarjeta);
        } else {
            tarjetasPago2.push(tarjeta);
        }
    }
});
            
            // Calcular cu치nto pagar en cada tarjeta de forma inteligente
            function calcularPagosTarjetas(tarjetas, disponible, balance) {
                const totalMinimos = tarjetas.reduce((sum, t) => sum + t.minimo, 0);
                const totalDeudas = tarjetas.reduce((sum, t) => sum + t.deuda, 0);
                
                if (disponible <= 0) {
                    // No hay dinero: pagar solo m칤nimos (o advertir que falta)
                    return tarjetas.map(t => ({
                        ...t,
                        pagoRecomendado: t.minimo,
                        pagoReal: 0,
                        faltante: t.minimo,
                        opcionMinimo: t.minimo,
                        opcionRecomendado: t.minimo
                    }));
                } else if (disponible < totalMinimos) {
                    // Hay dinero pero no alcanza para todos los m칤nimos
                    return tarjetas.map(t => {
                        const proporcion = totalDeudas > 0 ? (t.deuda / totalDeudas) : (1 / tarjetas.length);
                        const pagoAsignado = disponible * proporcion;
                        return {
                            ...t,
                            pagoRecomendado: t.minimo,
                            pagoReal: pagoAsignado,
                            faltante: t.minimo - pagoAsignado,
                            opcionMinimo: t.minimo,
                            opcionRecomendado: t.minimo
                        };
                    });
                } else {
                    // Hay dinero suficiente para m칤nimos
                    const sobrante = disponible - totalMinimos;
                    
                    if (tarjetas.length === 0) return [];
                    
                    return tarjetas.map(t => {
                        // Calcular diferentes opciones de pago
                        const opcionMinimo = t.minimo;
                        
                        // Opci칩n conservadora: m칤nimo + $20-50 dependiendo de la deuda
                        let extra;
                        if (t.deuda > 0) {
                            if (t.deuda < 500) {
                                extra = 20; // Deuda peque침a
                            } else if (t.deuda < 2000) {
                                extra = 30; // Deuda mediana
                            } else {
                                extra = 50; // Deuda grande
                            }
                        } else {
                            extra = 20; // Default
                        }
                        
                        // Asegurarnos de que el extra no exceda ciertos l칤mites
                        const limite1 = t.deuda * 0.15; // M치ximo 15% de la deuda
                        const limite2 = t.minimo * 2;   // M치ximo 2x el m칤nimo
                        extra = Math.min(extra, limite1, limite2);
                        
                        let opcionRecomendado = opcionMinimo + extra;
                        
                        // No pagar m치s de lo que se debe
                        if (t.deuda > 0 && opcionRecomendado > t.deuda) {
                            opcionRecomendado = t.deuda;
                            extra = t.deuda - opcionMinimo;
                        }
                        
                        // Si tenemos balance actual, usar opci칩n recomendada
                        // Si no, usar solo el m칤nimo
                        const pagoFinal = balance > 0 ? opcionRecomendado : opcionMinimo;
                        
                        return {
                            ...t,
                            pagoRecomendado: pagoFinal,
                            pagoReal: pagoFinal,
                            faltante: 0,
                            porcentajePagado: t.deuda > 0 ? ((pagoFinal / t.deuda) * 100).toFixed(1) : 0,
                            opcionMinimo: opcionMinimo,
                            opcionRecomendado: opcionRecomendado,
                            extraRecomendado: extra
                        };
                    });
                }
            }
            
            const tarjetasConPagoPago1 = calcularPagosTarjetas(tarjetasPago1, disponiblePago1, balanceActual);
            const tarjetasConPagoPago2 = calcularPagosTarjetas(tarjetasPago2, disponiblePago2, balanceActual);
            const tarjetasConPagoPago3 = esSemanal ? calcularPagosTarjetas(tarjetasPago3, disponiblePago3, balanceActual) : [];
            const tarjetasConPagoPago4 = esSemanal ? calcularPagosTarjetas(tarjetasPago4, disponiblePago4, balanceActual) : [];
            
            // Agregar tarjetas a los gastos de cada pago
            tarjetasConPagoPago1.forEach(t => {
                gastosPago1.push({
                    nombre: t.nombre,
                    monto: t.pagoReal,
                    dia: t.dia,
                    mes: t.mes,
                    tipo: 'tarjeta',
                    minimo: t.minimo,
                    pagoRecomendado: t.pagoRecomendado,
                    faltante: t.faltante
                });
            });
            
            tarjetasConPagoPago2.forEach(t => {
                gastosPago2.push({
                    nombre: t.nombre,
                    monto: t.pagoReal,
                    dia: t.dia,
                    mes: t.mes,
                    tipo: 'tarjeta',
                    minimo: t.minimo,
                    pagoRecomendado: t.pagoRecomendado,
                    faltante: t.faltante
                });
            });
            
            if (esSemanal) {
                tarjetasConPagoPago3.forEach(t => {
                    gastosPago3.push({
                        nombre: t.nombre,
                        monto: t.pagoReal,
                        dia: t.dia,
                        mes: t.mes,
                        tipo: 'tarjeta',
                        minimo: t.minimo,
                        pagoRecomendado: t.pagoRecomendado,
                        faltante: t.faltante
                    });
                });
                
                tarjetasConPagoPago4.forEach(t => {
                    gastosPago4.push({
                        nombre: t.nombre,
                        monto: t.pagoReal,
                        dia: t.dia,
                        mes: t.mes,
                        tipo: 'tarjeta',
                        minimo: t.minimo,
                        pagoRecomendado: t.pagoRecomendado,
                        faltante: t.faltante
                    });
                });
            }
            
            // Recalcular totales CON tarjetas
            const totalPago1 = gastosPago1.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago;
            const totalPago2 = gastosPago2.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago;
            const totalPago3 = esSemanal ? (gastosPago3.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago) : 0;
            const totalPago4 = esSemanal ? (gastosPago4.reduce((sum, g) => sum + g.monto, 0) + miscelaneosPorPago) : 0;
            
            const totalTarjetasPagado = tarjetasConPagoPago1.reduce((s, t) => s + t.pagoReal, 0) + 
                                        tarjetasConPagoPago2.reduce((s, t) => s + t.pagoReal, 0) +
                                        (esSemanal ? tarjetasConPagoPago3.reduce((s, t) => s + t.pagoReal, 0) : 0) +
                                        (esSemanal ? tarjetasConPagoPago4.reduce((s, t) => s + t.pagoReal, 0) : 0);
            
            const totalGastosCompleto = totalGastos + totalMiscelaneos + totalImprevistos + totalTarjetasPagado;
            
            const sobrante = capitalTotal - totalGastosCompleto - metaAhorro;
            const sobranteSinMeta = capitalTotal - totalGastosCompleto;
            const porcentajeAhorro = totalIngresos > 0 ? ((sobrante / totalIngresos) * 100).toFixed(1) : 0;
            
            // Variables de salud financiera
            const healthEmoji = sobrante >= capitalTotal * 0.2 ? '游릭 Excelente' : sobrante >= 0 ? '游리 Aceptable' : '游댮 Atenci칩n';
            const healthLabel = sobrante >= capitalTotal * 0.2 ? '춰Salud financiera excelente!' : sobrante >= 0 ? 'Finanzas equilibradas' : 'Gastos exceden ingresos';

            // Generar resultado
            let resultadoHTML = `
                <div class="resultado-header">
                    <h2>游늵 Tu Plan Financiero</h2>
                    <div class="health-badge">${healthEmoji}</div>
                </div>
                
                ${metaAhorro > 0 ? `
                <!-- BARRA DE PROGRESO META DE AHORRO -->
                <div class="resumen-box" style="border-left-color: #f57c00;">
                    <h3 style="color: #f57c00; margin-bottom: 15px;">游꿢 Progreso de Meta de Ahorro</h3>
                    <p style="color: #666; margin-bottom: 10px;">Meta: $${metaAhorro.toFixed(2)}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${Math.min((sobrante / metaAhorro) * 100, 100)}%">
                            ${sobrante >= metaAhorro ? '九 Meta Alcanzada!' : `${((sobrante / metaAhorro) * 100).toFixed(0)}%`}
                        </div>
                    </div>
                    ${sobrante >= metaAhorro ? 
                        '<p style="color: #51cf66; margin-top: 10px; font-weight: bold;">游꿀 춰Felicitaciones! Alcanzaste tu meta de ahorro.</p>' : 
                        `<p style="color: #666; margin-top: 10px;">Faltan $${(metaAhorro - sobrante).toFixed(2)} para alcanzar tu meta.</p>`
                    }
                </div>
                ` : ''}
                
                <!-- GR츼FICA DE DISTRIBUCI칍N DE GASTOS -->
                <div class="chart-container">
                    <h3 style="color: #667eea; margin-bottom: 15px;">游늵 Distribuci칩n de tus Gastos</h3>
                    <canvas id="gastosChart"></canvas>
                </div>
                
                <!-- ALERTAS INTELIGENTES -->
                <div class="smart-alerts">
                    <h3 style="color: #667eea; margin-bottom: 15px;">游눠 Alertas Inteligentes</h3>
                </div>
                
                <div class="resultado-metrics">
                    <div class="metric-card">
                        <div class="metric-icon">游눯</div>
                        <div class="metric-label">Capital Total</div>
                        <div class="metric-value neutro">$${capitalTotal.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">游늴</div>
                        <div class="metric-label">Total Gastos</div>
                        <div class="metric-value negativo">$${totalGastosCompleto.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">${sobrante >= 0 ? '九' : '丘멆잺'}</div>
                        <div class="metric-label">Sobrante</div>
                        <div class="metric-value ${sobrante >= 0 ? 'positivo' : 'negativo'}">${sobrante >= 0 ? '+' : ''}$${sobrante.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">游늵</div>
                        <div class="metric-label">% Ahorro</div>
                        <div class="metric-value ${porcentajeAhorro > 0 ? 'positivo' : 'negativo'}">${porcentajeAhorro}%</div>
                    </div>
                </div>
                
                <div class="paycheck-card">
                    <div class="paycheck-card-header">
                        <span>游눱 PAYCHECK 1  ${diaPago1} de ${mesesNombres[mesPago1]}</span>
                        <span>$${montoPago1.toFixed(2)}</span>
                    </div>
                    <div class="paycheck-card-body">
            `;
            
            if (gastosPago1.length > 0) {
                gastosPago1.sort((a, b) => a.dia - b.dia).forEach(gasto => {
                    const mesTexto = gasto.mes && gasto.mes !== 'todos' ? ` de ${mesesNombres[parseInt(gasto.mes)]}` : '';
                    
                    let tipoClass = 'tipo-fijo';
                    let icon = '九';
                    let detalle = '';

                    if (gasto.tipo === 'tarjeta') {
                        tipoClass = 'tipo-tarjeta';
                        icon = '游눱';

                        if (gasto.faltante && gasto.faltante > 0) {
                            detalle = `<span style="color: #ff6b6b; font-size:0.85em;">丘멆잺 Falta $${gasto.faltante.toFixed(2)} para el m칤nimo de $${(gasto.minimo || 0).toFixed(2)}</span>`;
                        } else if (gasto.opcionMinimo && gasto.opcionRecomendado) {
                            let detalleDeuda = gasto.deuda > 0 ? `  Balance: $${gasto.deuda.toFixed(2)}` : '';
                            let extra = gasto.extraRecomendado || 0;
                            detalle = `<span style="font-size:0.85em;"><span style="color:#ff9800;">M칤n. $${gasto.opcionMinimo.toFixed(2)}</span> 췅 <span style="color:#51cf66;">Rec. $${gasto.opcionRecomendado.toFixed(2)} (+$${extra.toFixed(2)})</span>${detalleDeuda}</span>`;
                        } else {
                            let detalleDeuda = gasto.deuda > 0 ? `  Balance: $${gasto.deuda.toFixed(2)}` : '';
                            detalle = `<span style="color:#ff9800; font-size:0.85em;">M칤nimo: $${(gasto.minimo || 0).toFixed(2)}${detalleDeuda}</span>`;
                        }
                    } else if (gasto.tipo === 'variable') {
                        tipoClass = 'tipo-variable';
                        icon = '游닍';
                    } else if (gasto.tipo === 'imprevisto') {
                        tipoClass = 'tipo-imprevisto';
                        icon = '游뚿';
                        detalle = `<span style="color:#ff6b6b; font-size:0.85em;">(GASTO 칔NICO - Solo este mes)</span>`;
                    }

                    resultadoHTML += `
                        <div class="gasto-linea ${tipoClass}">
                            <div class="gasto-linea-icon">${icon}</div>
                            <div class="gasto-linea-info">
                                <strong>${gasto.nombre}</strong>  d칤a ${gasto.dia}${mesTexto}
                                ${detalle ? `<br>${detalle}` : ''}
                            </div>
                            <div class="gasto-linea-monto">$${gasto.monto.toFixed(2)}</div>
                        </div>
                    `;
                });
            }
            
            if (totalMiscelaneos > 0) {
                resultadoHTML += `
                    <div class="gasto-linea tipo-misc">
                        <div class="gasto-linea-icon">游꿢</div>
                        <div class="gasto-linea-info"><strong>Miscel치neos (1ra quincena)</strong></div>
                        <div class="gasto-linea-monto">$${miscelaneosPorPago.toFixed(2)}</div>
                    </div>
                `;
            }

            if (gastosPago1.length > 0 || totalMiscelaneos > 0) {
                const ahorroPorPaycheck = metaAhorro / (esSemanal ? 4 : 2);
                const sobranteDespuesAhorro1 = (montoPago1 - totalPago1) - ahorroPorPaycheck;
                const sobrante1 = montoPago1 - totalPago1;

                resultadoHTML += `
                    <div class="paycheck-total">
                        <span>Total a pagar</span>
                        <span style="color: ${sobrante1 >= 0 ? '#37b24d' : '#ff6b6b'};">
                            $${totalPago1.toFixed(2)}
                            <span style="font-size:0.85em; font-weight:400; margin-left:6px;">(te ${sobrante1 >= 0 ? 'sobran' : 'faltan'} $${Math.abs(sobrante1).toFixed(2)})</span>
                        </span>
                    </div>
                    ${metaAhorro > 0 ? `
                    <div style="background: #51cf66; color: white; padding: 10px 14px; border-radius: 8px; margin-top: 8px; font-size:0.9em;">
                        游눯 <strong>Ahorro:</strong> Aparta $${ahorroPorPaycheck.toFixed(2)} apenas cobres
                        췅 Quedan: <strong>$${sobranteDespuesAhorro1.toFixed(2)}</strong>
                    </div>` : ''}
                `;
            } else {
                resultadoHTML += `<p style="color: #999; padding: 10px 15px;">No hay gastos asignados a este pago</p>`;
            }

            resultadoHTML += `
                    </div>
                </div>

                <div class="paycheck-card">
                    <div class="paycheck-card-header">
                        <span>游눱 PAYCHECK 2  ${diaPago2} de ${mesesNombres[mesPago2]}</span>
                        <span>$${montoPago2.toFixed(2)}</span>
                    </div>
                    <div class="paycheck-card-body">
            `;
            
            if (gastosPago2.length > 0) {
                gastosPago2.sort((a, b) => a.dia - b.dia).forEach(gasto => {
                    const mesTexto = gasto.mes && gasto.mes !== 'todos' ? ` de ${mesesNombres[parseInt(gasto.mes)]}` : '';
                    
                    let tipoClass = 'tipo-fijo';
                    let icon = '九';
                    let detalle = '';

                    if (gasto.tipo === 'tarjeta') {
                        tipoClass = 'tipo-tarjeta';
                        icon = '游눱';

                        if (gasto.faltante && gasto.faltante > 0) {
                            detalle = `<span style="color: #ff6b6b; font-size:0.85em;">丘멆잺 Falta $${gasto.faltante.toFixed(2)} para el m칤nimo de $${(gasto.minimo || 0).toFixed(2)}</span>`;
                        } else if (gasto.opcionMinimo && gasto.opcionRecomendado) {
                            let detalleDeuda = gasto.deuda > 0 ? `  Balance: $${gasto.deuda.toFixed(2)}` : '';
                            let extra = gasto.extraRecomendado || 0;
                            detalle = `<span style="font-size:0.85em;"><span style="color:#ff9800;">M칤n. $${gasto.opcionMinimo.toFixed(2)}</span> 췅 <span style="color:#51cf66;">Rec. $${gasto.opcionRecomendado.toFixed(2)} (+$${extra.toFixed(2)})</span>${detalleDeuda}</span>`;
                        } else {
                            let detalleDeuda = gasto.deuda > 0 ? `  Balance: $${gasto.deuda.toFixed(2)}` : '';
                            detalle = `<span style="color:#ff9800; font-size:0.85em;">M칤nimo: $${(gasto.minimo || 0).toFixed(2)}${detalleDeuda}</span>`;
                        }
                    } else if (gasto.tipo === 'variable') {
                        tipoClass = 'tipo-variable';
                        icon = '游닍';
                    } else if (gasto.tipo === 'imprevisto') {
                        tipoClass = 'tipo-imprevisto';
                        icon = '游뚿';
                        detalle = `<span style="color:#ff6b6b; font-size:0.85em;">(GASTO 칔NICO - Solo este mes)</span>`;
                    }

                    resultadoHTML += `
                        <div class="gasto-linea ${tipoClass}">
                            <div class="gasto-linea-icon">${icon}</div>
                            <div class="gasto-linea-info">
                                <strong>${gasto.nombre}</strong>  d칤a ${gasto.dia}${mesTexto}
                                ${detalle ? `<br>${detalle}` : ''}
                            </div>
                            <div class="gasto-linea-monto">$${gasto.monto.toFixed(2)}</div>
                        </div>
                    `;
                });
            }
            
            if (totalMiscelaneos > 0) {
                resultadoHTML += `
                    <div class="gasto-linea tipo-misc">
                        <div class="gasto-linea-icon">游꿢</div>
                        <div class="gasto-linea-info"><strong>Miscel치neos (2da quincena)</strong></div>
                        <div class="gasto-linea-monto">$${miscelaneosPorPago.toFixed(2)}</div>
                    </div>
                `;
            }

            if (gastosPago2.length > 0 || totalMiscelaneos > 0) {
                const ahorroPorPaycheck = metaAhorro / (esSemanal ? 4 : 2);
                const sobranteDespuesAhorro2 = (montoPago2 - totalPago2) - ahorroPorPaycheck;
                const sobrante2 = montoPago2 - totalPago2;

                resultadoHTML += `
                    <div class="paycheck-total">
                        <span>Total a pagar</span>
                        <span style="color: ${sobrante2 >= 0 ? '#37b24d' : '#ff6b6b'};">
                            $${totalPago2.toFixed(2)}
                            <span style="font-size:0.85em; font-weight:400; margin-left:6px;">(te ${sobrante2 >= 0 ? 'sobran' : 'faltan'} $${Math.abs(sobrante2).toFixed(2)})</span>
                        </span>
                    </div>
                    ${metaAhorro > 0 ? `
                    <div style="background: #51cf66; color: white; padding: 10px 14px; border-radius: 8px; margin-top: 8px; font-size:0.9em;">
                        游눯 <strong>Ahorro:</strong> Aparta $${ahorroPorPaycheck.toFixed(2)} apenas cobres
                        췅 Quedan: <strong>$${sobranteDespuesAhorro2.toFixed(2)}</strong>
                    </div>` : ''}
                `;
            } else {
                resultadoHTML += `<p style="color: #999; padding: 10px 15px;">No hay gastos asignados a este pago</p>`;
            }

            resultadoHTML += `
                    </div>
                </div>
            `;
            
            // COMPARACI칍N DE PAYCHECKS
            const sobrantePago1 = montoPago1 - totalPago1;
            const sobrantePago2 = montoPago2 - totalPago2;
            const diferenciaPaychecks = Math.abs(sobrantePago1 - sobrantePago2);
            
            resultadoHTML += `
                <div class="resumen-box" style="border-left-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">丘뒲잺 Comparaci칩n de PayChecks</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: ${sobrantePago1 >= sobrantePago2 ? '#d1e7dd' : '#fff3cd'}; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">游눱 PayCheck 1</div>
                            <div style="font-size: 1.3em; font-weight: bold; color: ${sobrantePago1 >= 0 ? '#37b24d' : '#ff6b6b'};">
                                ${sobrantePago1 >= 0 ? 'Sobran' : 'Faltan'}: $${Math.abs(sobrantePago1).toFixed(2)}
                            </div>
                            ${sobrantePago1 >= sobrantePago2 ? '<div style="margin-top: 5px; color: #37b24d;">九 M치s Alivio</div>' : ''}
                        </div>
                        <div style="background: ${sobrantePago2 >= sobrantePago1 ? '#d1e7dd' : '#fff3cd'}; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">游눱 PayCheck 2</div>
                            <div style="font-size: 1.3em; font-weight: bold; color: ${sobrantePago2 >= 0 ? '#37b24d' : '#ff6b6b'};">
                                ${sobrantePago2 >= 0 ? 'Sobran' : 'Faltan'}: $${Math.abs(sobrantePago2).toFixed(2)}
                            </div>
                            ${sobrantePago2 >= sobrantePago1 ? '<div style="margin-top: 5px; color: #37b24d;">九 M치s Alivio</div>' : ''}
                        </div>
                    </div>
                    <div style="background: ${sobrantePago1 >= 0 && sobrantePago2 >= 0 ? '#e7f5ff' : '#fff3cd'}; padding: 12px; border-radius: 8px; text-align: center; font-size: 0.9em;">
                        ${sobrantePago1 >= 0 && sobrantePago2 >= 0 ? 
                            `游눠 <strong>Ambos paychecks est치n balanceados.</strong> Diferencia: $${diferenciaPaychecks.toFixed(2)}` :
                            sobrantePago1 < 0 || sobrantePago2 < 0 ?
                            `丘멆잺 <strong>Atenci칩n:</strong> Al menos un paycheck tiene d칠ficit. Considera redistribuir gastos.` :
                            `丘 <strong>El PayCheck ${sobrantePago1 < sobrantePago2 ? '1' : '2'} est치 m치s ajustado.</strong> Diferencia: $${diferenciaPaychecks.toFixed(2)}`
                        }
                    </div>
                </div>
            `;
            
            // AN츼LISIS DE GASTOS IMPREVISTOS
            if (totalImprevistos > 0) {
                const porcentajeImprevistos = (totalImprevistos / totalIngresos * 100).toFixed(1);
                const imprevistosDesglose = imprevistos.map(imp => `<li><strong>${imp.nombre}:</strong> $${imp.monto.toFixed(2)}</li>`).join('');
                
                resultadoHTML += `
                    <div class="resumen-box" style="border-left-color: #ff6b6b; background: linear-gradient(135deg, #fff5f5 0%, #ffe9e9 100%);">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">游뚿 An치lisis de Gastos Imprevistos</h3>
                        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-size: 1.1em; font-weight: bold;">Total Imprevistos Este Mes:</span>
                                <span style="font-size: 1.5em; font-weight: bold; color: #ff6b6b;">$${totalImprevistos.toFixed(2)}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                Representa el <strong>${porcentajeImprevistos}%</strong> de tus ingresos mensuales
                            </div>
                        </div>
                        
                        <div style="background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="color: #666; margin-bottom: 10px; font-size: 0.95em;">游늶 Desglose:</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #333;">
                                ${imprevistosDesglose}
                            </ul>
                        </div>
                        
                        <div style="background: #e7f5ff; padding: 15px; border-radius: 10px;">
                            <strong style="color: #1c7ed6;">游눠 Buenas Noticias:</strong>
                            <p style="margin: 8px 0 0 0; color: #495057;">
                                Estos gastos <strong>NO se repetir치n el pr칩ximo mes.</strong> 
                                Si mantienes tus gastos fijos actuales, tendr치s aproximadamente 
                                <strong style="color: #37b24d;">$${totalImprevistos.toFixed(2)} m치s disponibles</strong> 
                                el pr칩ximo mes para ahorrar o para otros objetivos.
                            </p>
                        </div>
                        
                        ${totalImprevistos > totalIngresos * 0.2 ? `
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; color: #856404;">
                            丘멆잺 <strong>Consejo:</strong> Los imprevistos representan m치s del 20% de tus ingresos. 
                            Considera crear un fondo de emergencia para estos casos.
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Desglose de miscel치neos
            if (miscelaneos.length > 0) {
                resultadoHTML += `
                    <div class="resumen-box" style="border-left-color: #ffd43b;">
                        <h3 style="color: #f59f00; margin-bottom: 15px;">游꿢 Desglose de Miscel치neos</h3>
                        <p style="color: #666; margin-bottom: 10px; font-size: 0.9em;">
                            Presupuesto sugerido dividido entre tus 2 quincenas ($${miscelaneosPorPago.toFixed(2)} c/u):
                        </p>
                `;
                
                miscelaneos.forEach(misc => {
                    if (!misc || !misc.monto) return; // Skip if undefined
                    const porPago = misc.monto / 2;
                    resultadoHTML += `
                        <div class="resumen-item">
                            <span> ${misc.nombre || 'Sin nombre'}</span>
                            <span style="color: #f59f00;">$${misc.monto.toFixed(2)}/mes ($${porPago.toFixed(2)} c/quincena)</span>
                        </div>
                    `;
                });
                
                resultadoHTML += `
                        <div style="margin-top: 15px; padding: 10px; background: #fffbf0; border-radius: 5px; font-size: 0.9em; color: #666;">
                            游눠 <strong>Tip:</strong> Intenta no exceder estos montos para mantener tus finanzas en orden
                        </div>
                    </div>
                `;
            }
            
            if (sobrante > 0) {
                const ahorroSugerido = Math.floor(sobrante * 0.8);
                const emergencias = sobrante - ahorroSugerido;
                
                resultadoHTML += `
                    <div class="ahorro-box">
                        <h3>游꿢 Plan de Ahorro Sugerido</h3>
                        <div class="ahorro-amount">$${ahorroSugerido.toFixed(2)}</div>
                        <p style="font-size: 1.1em;">Puedes ahorrar este mes (${porcentajeAhorro}% de tus ingresos)</p>
                        <p style="margin-top: 10px; font-size: 0.95em;">游눠 Deja $${emergencias.toFixed(2)} para imprevistos</p>
                        <p style="margin-top: 5px; font-size: 0.9em;">游늳 En un a침o ahorrar칤as: $${(ahorroSugerido * 12).toFixed(2)}</p>
                    </div>
                `;
            } else if (sobrante < 0) {
                resultadoHTML += `
                    <div class="alert">
                        丘멆잺 ALERTA: Tus gastos superan tus ingresos por $${Math.abs(sobrante).toFixed(2)}
                    </div>
                    <div class="consejos">
                        <h3 style="color: #f59f00; margin-bottom: 15px;">丘 Recomendaciones Urgentes:</h3>
                        <div class="consejo-item">游댌 Revisa los gastos que puedas reducir o eliminar</div>
                        <div class="consejo-item">游눫 Negocia pagos o plazos con tus proveedores</div>
                        <div class="consejo-item">游늵 Busca ingresos adicionales temporales</div>
                        <div class="consejo-item">游꿢 Prioriza los gastos esenciales (servicios b치sicos)</div>
                        <div class="consejo-item">游꿢 <strong>Reduce miscel치neos:</strong> Son gastos variables que puedes controlar</div>
                    </div>
                `;
            }
            
            // GENERAR CONSEJOS PERSONALIZADOS
            let consejosHTML = '';
            let numConsejos = 0;
            
            // Consejo 1: Sobre tarjetas de cr칠dito (si hay)
            if (tarjetas.length > 0) {
                const totalDeudasTarjetas = tarjetas.reduce((sum, t) => sum + t.deuda, 0);
                const totalMinimos = tarjetas.reduce((sum, t) => sum + t.minimo, 0);
                const pagoExtra = totalDeudasTarjetas - totalMinimos;
                
                if (totalDeudasTarjetas > totalMinimos * 2) {
                    consejosHTML += `
                        <div class="consejo-item">
                            游눱 <strong>Tus Tarjetas:</strong> Debes $${totalDeudasTarjetas.toFixed(2)} en total. 
                            Si pagas solo el m칤nimo ($${totalMinimos.toFixed(2)}), tardar치s mucho en liquidar. 
                            ${sobrante > 100 ? `Intenta abonar $${Math.min(sobrante * 0.3, pagoExtra * 0.2).toFixed(2)} extra este mes.` : ''}
                        </div>
                    `;
                    numConsejos++;
                }
            }
            
            // Consejo 2: Sobre el paycheck m치s ajustado
            // Ya tenemos sobrantePago1 y sobrantePago2 declarados arriba, los reutilizamos
            
            if (Math.abs(sobrantePago1 - sobrantePago2) > 200) {
                const paycheckAjustado = sobrantePago1 < sobrantePago2 ? 1 : 2;
                const diferencia = Math.abs(sobrantePago1 - sobrantePago2);
                consejosHTML += `
                    <div class="consejo-item">
                        丘뒲잺 <strong>Balance de PayChecks:</strong> Tu PayCheck ${paycheckAjustado} est치 $${diferencia.toFixed(2)} m치s ajustado. 
                        Considera mover algunos gastos flexibles al otro paycheck para equilibrar mejor.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 3: Sobre fondo de emergencia
            const fondoRecomendado = totalGastos * 3;
            if (balanceActual < fondoRecomendado) {
                const faltaFondo = fondoRecomendado - balanceActual;
                const mesesParaFondo = Math.ceil(faltaFondo / (sobrante > 0 ? sobrante : 1));
                consejosHTML += `
                    <div class="consejo-item">
                        游꿢 <strong>Fondo de Emergencia:</strong> Se recomienda tener 3 meses de gastos ahorrados ($${fondoRecomendado.toFixed(2)}). 
                        Te falta $${faltaFondo.toFixed(2)}. ${sobrante > 0 ? `Ahorrando tu sobrante actual, lo lograr칤as en ~${mesesParaFondo} meses.` : 'Intenta reducir gastos para crear este fondo.'}
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 4: Sobre imprevistos
            if (totalImprevistos > totalIngresos * 0.15) {
                consejosHTML += `
                    <div class="consejo-item">
                        游뚿 <strong>Gastos Imprevistos:</strong> Este mes tuviste $${totalImprevistos.toFixed(2)} en imprevistos (${(totalImprevistos/totalIngresos*100).toFixed(1)}% de tus ingresos). 
                        Como no son recurrentes, el pr칩ximo mes podr치s usar ese dinero para ahorrar o pagar deudas.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 5: Sobre ahorro (si est치 bien)
            if (sobrante > capitalTotal * 0.2) {
                const ahorroAnual = sobrante * 12;
                consejosHTML += `
                    <div class="consejo-item">
                        游꿀 <strong>춰Excelente Ahorro!</strong> Est치s ahorrando ${((sobrante/capitalTotal)*100).toFixed(1)}% de tu capital. 
                        Si mantienes este ritmo, en un a침o ahorrar치s $${ahorroAnual.toFixed(2)}. 
                        Considera invertir parte de ese dinero para que crezca m치s.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 6: Sobre gastos de transporte (si son altos)
            const gastosTransporte = gastos.filter(g => g.nombre.toLowerCase().includes('carro') || g.nombre.toLowerCase().includes('gasolina')).reduce((sum, g) => sum + g.monto, 0);
            if (gastosTransporte > totalIngresos * 0.2) {
                consejosHTML += `
                    <div class="consejo-item">
                        游뚱 <strong>Transporte:</strong> Gastas $${gastosTransporte.toFixed(2)} en transporte (${(gastosTransporte/totalIngresos*100).toFixed(1)}% de ingresos). 
                        Lo recomendado es 15-20%. Considera carpooling o transporte p칰blico para reducir este gasto.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 7: Sobre fecha de vencimiento (si hay gastos cerca)
            const hoy = new Date().getDate();
            const gastosProximos = gastos.filter(g => g.dia <= hoy + 7 && g.dia >= hoy);
            if (gastosProximos.length > 0) {
                const nombresGastos = gastosProximos.map(g => g.nombre).slice(0, 3).join(', ');
                consejosHTML += `
                    <div class="consejo-item">
                        游늰 <strong>Pr칩ximos Vencimientos:</strong> En los pr칩ximos 7 d칤as vencen: ${nombresGastos}${gastosProximos.length > 3 ? ' y otros' : ''}. 
                        Aseg칰rate de tener el dinero disponible para evitar cargos por mora.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 8: Domiciliar pagos (si hay muchos gastos)
            if (gastos.length >= 5) {
                consejosHTML += `
                    <div class="consejo-item">
                        游님 <strong>Domicilia tus Pagos:</strong> Tienes ${gastos.length} gastos fijos mensuales. 
                        Considera domiciliar al menos ${Math.min(5, gastos.length)} de ellos para no olvidar ning칰n pago.
                    </div>
                `;
                numConsejos++;
            }
            
            // Consejo 9: Regla 50/30/20 personalizada
            const porcentajeNecesidades = (totalGastos / totalIngresos) * 100;
            const porcentajeAhorroLocal = (sobrante / totalIngresos) * 100;
            consejosHTML += `
                <div class="consejo-item">
                    游눯 <strong>Tu Regla Personal:</strong> Actualmente: ${porcentajeNecesidades.toFixed(0)}% necesidades, ${porcentajeAhorroLocal.toFixed(0)}% ahorro. 
                    ${porcentajeAhorroLocal >= 20 ? '춰Cumples con la regla 50/30/20! 游꿢' : `Intenta llegar al 20% de ahorro (faltan ${(20-porcentajeAhorroLocal).toFixed(0)}%).`}
                </div>
            `;
            numConsejos++;
            
            // Si no hay suficientes consejos, agregar consejos generales 칰tiles
            if (numConsejos < 5) {
                consejosHTML += `
                    <div class="consejo-item">
                        游 <strong>Guarda Este Mes:</strong> Usa el bot칩n "游 Guardar Este Mes" para hacer seguimiento de tu progreso mensual y comparar tu evoluci칩n.
                    </div>
                `;
            }
            
            resultadoHTML += `
                <div class="consejos">
                    <h3 style="color: #f59f00; margin-bottom: 15px;">游눠 Consejos Personalizados Para Ti</h3>
                    ${consejosHTML || '<div class="consejo-item">九 춰Todo se ve bien! Contin칰a as칤 y revisa mensualmente.</div>'}
                </div>
                
                <div class="action-buttons">
                    <button onclick="guardarMes()" class="btn-secondary" style="flex: 1; min-width: 200px;">
                        游 GUARDAR ESTE MES
                    </button>
                    <button onclick="verProgresoAhorro()" class="btn-secondary" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        游늵 VER PROGRESO DE AHORRO
                    </button>
                    <button onclick="verHistorial()" class="btn-secondary" style="flex: 1; min-width: 200px;">
                        游늭 VER MESES ANTERIORES
                    </button>
                    <button onclick="compararMeses()" class="btn-secondary" style="flex: 1; min-width: 200px;">
                        游늳 COMPARAR MESES
                    </button>
                </div>
                
                <button onclick="exportarPDF()" style="width: 100%; background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 10px 30px rgba(81, 207, 102, 0.3); transition: all 0.3s;">
                    游둳勇 IMPRIMIR / GUARDAR COMO PDF
                </button>
                
                <div style="margin-top: 15px; padding: 15px; background: #e7f5ff; border-radius: 10px; font-size: 0.9em; color: #1c7ed6;">
                    <strong>游눠 쯅o funciona el bot칩n?</strong><br>
                    <strong>En computadora:</strong> Presiona Ctrl+P (Windows) o Cmd+P (Mac)<br>
                    <strong>En iPhone/iPad:</strong> Toca el bot칩n de compartir 游댕 arriba, luego selecciona "Imprimir" o captura de pantalla y comp치rtela
                </div>
            `;
            
            // GENERAR ALERTAS INTELIGENTES
            let alertasHTML = '';
            
            // Alerta: Renta muy alta
            const porcentajeRenta = (gastos.find(g => g.nombre && g.nombre.toLowerCase().includes('renta'))?.monto || 0) / totalIngresos * 100;
            if (porcentajeRenta > 30) {
                alertasHTML += `
                    <div class="alert-item alert-warning">
                        <span class="icon">丘멆잺</span>
                        <div class="content">
                            <strong>Renta Alta</strong>
                            <p>Tu renta es el ${porcentajeRenta.toFixed(0)}% de tus ingresos. Lo recomendado es m치ximo 30%.</p>
                        </div>
                    </div>
                `;
            }
            
            // Alerta: Sin ahorro
            if (sobrante <= 0) {
                alertasHTML += `
                    <div class="alert-item alert-warning">
                        <span class="icon">游눶</span>
                        <div class="content">
                            <strong>Sin Capacidad de Ahorro</strong>
                            <p>Tus gastos igualan o superan tus ingresos. Considera reducir gastos no esenciales.</p>
                        </div>
                    </div>
                `;
            }
            
            // Alerta: Buen ahorro
            if (sobrante > capitalTotal * 0.2) {
                alertasHTML += `
                    <div class="alert-item alert-success">
                        <span class="icon">游꿀</span>
                        <div class="content">
                            <strong>춰Excelente Ahorro!</strong>
                            <p>Est치s ahorrando m치s del 20% de tu capital. 춰Sigue as칤!</p>
                        </div>
                    </div>
                `;
            }
            
            // Alerta: Deuda de tarjetas alta
            if (totalDeudasTarjetas > totalIngresos) {
                alertasHTML += `
                    <div class="alert-item alert-warning">
                        <span class="icon">游눱</span>
                        <div class="content">
                            <strong>Deuda de Tarjetas Alta</strong>
                            <p>Debes $${totalDeudasTarjetas.toFixed(2)} en tarjetas, m치s que tus ingresos mensuales. Considera un plan de pago agresivo.</p>
                        </div>
                    </div>
                `;
            }
            
            // Alerta: Sin fondo de emergencia
            if (balanceActual < totalGastos) {
                alertasHTML += `
                    <div class="alert-item alert-info">
                        <span class="icon">游눠</span>
                        <div class="content">
                            <strong>Fondo de Emergencia</strong>
                            <p>Tu balance actual ($${balanceActual.toFixed(2)}) es menor que tus gastos mensuales. Se recomienda tener 3-6 meses de gastos ahorrados.</p>
                        </div>
                    </div>
                `;
            }
            
            // Insertar alertas en el HTML
            resultadoHTML = resultadoHTML.replace('<div class="smart-alerts">', `<div class="smart-alerts">${alertasHTML || '<p style="color: #666; text-align: center;">Sin alertas por ahora. 춰Todo bien! 游녨</p>'}`);
            
            document.getElementById('resultado').innerHTML = resultadoHTML;
            document.getElementById('resultado').classList.add('show');
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // GENERAR GR츼FICA DE PASTEL
            setTimeout(() => {
                const ctx = document.getElementById('gastosChart');
                if (ctx) {
                    // Calcular categor칤as de gastos
                    const categorias = {
                        'Servicios del Hogar': 0,
                        'Vivienda': 0,
                        'Transporte': 0,
                        'Alimentaci칩n': 0,
                        'Tarjetas de Cr칠dito': 0,
                        'Miscel치neos': totalMiscelaneos,
                        'Imprevistos': totalImprevistos,
                        'Otros': 0
                    };
                    
                    gastos.forEach(gasto => {
                        const nombre = gasto.nombre.toLowerCase();
                        if (nombre.includes('agua') || nombre.includes('luz') || nombre.includes('internet') || nombre.includes('tel칠fono') || nombre.includes('telefono')) {
                            categorias['Servicios del Hogar'] += gasto.monto;
                        } else if (nombre.includes('renta') || nombre.includes('hipoteca')) {
                            categorias['Vivienda'] += gasto.monto;
                        } else if (nombre.includes('carro') || nombre.includes('gasolina') || nombre.includes('transporte')) {
                            categorias['Transporte'] += gasto.monto;
                        } else if (nombre.includes('comida') || nombre.includes('despensa') || nombre.includes('alimento')) {
                            categorias['Alimentaci칩n'] += gasto.monto;
                        } else {
                            categorias['Otros'] += gasto.monto;
                        }
                    });
                    
                    tarjetas.forEach(t => {
                        categorias['Tarjetas de Cr칠dito'] += t.minimo;
                    });
                    
                    // Filtrar categor칤as con valor > 0
                    const labels = [];
                    const data = [];
                    const colors = ['#51cf66', '#667eea', '#ffd43b', '#ff6b6b', '#e91e63', '#f59f00', '#fa5252', '#868e96'];
                    const backgroundColors = [];
                    
                    let colorIndex = 0;
                    Object.keys(categorias).forEach(key => {
                        if (categorias[key] > 0) {
                            labels.push(key);
                            data.push(categorias[key]);
                            backgroundColors.push(colors[colorIndex % colors.length]);
                            colorIndex++;
                        }
                    });
                    
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors,
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
            
            // ==================== ACTUALIZAR NOTIFICACIONES ====================
            if (typeof actualizarNotificaciones === 'function') {
                try {
                    actualizarNotificaciones();
                } catch (notifError) {
                    console.log('좶잺 Notificaciones no disponibles:', notifError);
                }
            }

            // ==================== RESUMEN R츼PIDO EN BARRA ====================
            const resumenEl = document.getElementById('resumen-rapido');
            if (resumenEl) {
                const pos = sobrante >= 0;
                resumenEl.innerHTML = `<span class="resumen-badge ${pos ? 'resumen-positivo' : 'resumen-negativo'}">
                    ${pos ? '九' : '丘멆잺'} Sobrante: ${pos ? '+' : ''}$${sobrante.toFixed(2)}
                </span>`;
            }

            } catch (error) {
                console.error('仇 Error detallado:', error);
                console.error('Stack:', error.stack);
                alert('仇 Error al calcular:\n\n' + error.message + '\n\nRevisa la consola (F12) para m치s detalles.');
            }
        }
        
        // ==================== FUNCIONES DE GUARDADO ====================
        
        function guardarMes() {
            // Obtener datos actuales del formulario
            const mesActual = document.getElementById('mes-pago1').value;
            const a침oActual = new Date().getFullYear();
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const nombreMes = mesesNombres[parseInt(mesActual)];
            
            // Crear clave 칰nica para el mes
            const clave = `finanzas_${a침oActual}_${mesActual.padStart(2, '0')}`;
            
            // Obtener tipo de ahorro y datos relacionados
            const tipoAhorro = document.querySelector('input[name="tipo-ahorro"]:checked').value;
            const metaAhorro = parseFloat(document.getElementById('meta-ahorro').value) || 0;
            
            let objetivoAhorro = null;
            if (tipoAhorro === 'fecha') {
                const metaTotal = parseFloat(document.getElementById('meta-total').value) || 0;
                const fechaObjetivo = document.getElementById('fecha-objetivo').value;
                
                if (metaTotal > 0 && fechaObjetivo) {
                    objetivoAhorro = {
                        metaTotal: metaTotal,
                        fechaObjetivo: fechaObjetivo,
                        ahorroPorMes: metaAhorro
                    };
                }
            }
            
            // Recolectar TODOS los gastos fijos
            const gastosFijos = [];
            const filasGastosFijos = document.querySelectorAll('#tabla-gastos-fijos-body .gasto-fijo-row');
            filasGastosFijos.forEach(fila => {
                const nombre = fila.querySelector('.gasto-fijo-nombre')?.value || '';
                const monto = parseFloat(fila.querySelector('.gasto-fijo-monto')?.value) || 0;
                const dia = parseInt(fila.querySelector('.gasto-fijo-dia')?.value) || 0;
                const mes = fila.querySelector('.gasto-fijo-mes')?.value || '';
                const recurrencia = fila.querySelector('.gasto-fijo-recurrencia')?.value || '';
                
                if (nombre && monto > 0) {
                    gastosFijos.push({ nombre, monto, dia, mes, recurrencia });
                }
            });
            
            // Recolectar tarjetas
            const tarjetas = [];
            const tarjetasElements = document.querySelectorAll('#tarjetas-container .gasto-categoria');
            tarjetasElements.forEach(tarjetaEl => {
                const nombre = tarjetaEl.querySelector('.tarjeta-nombre')?.value || '';
                const minimo = parseFloat(tarjetaEl.querySelector('.tarjeta-minimo')?.value) || 0;
                const deuda = parseFloat(tarjetaEl.querySelector('.tarjeta-deuda')?.value) || 0;
                const mes = tarjetaEl.querySelector('.tarjeta-mes')?.value || '';
                const dia = parseInt(tarjetaEl.querySelector('.tarjeta-dia')?.value) || 0;
                
                if (nombre && minimo > 0) {
                    tarjetas.push({ nombre, minimo, deuda, mes, dia });
                }
            });
            
            // Recolectar miscel치neos
            const miscelaneos = [];
            const miscelaneosElements = document.querySelectorAll('#miscelaneos-container .gasto-item');
            miscelaneosElements.forEach(miscEl => {
                const nombre = miscEl.querySelector('.miscelaneo-nombre-input')?.value || '';
                const monto = parseFloat(miscEl.querySelector('.miscelaneo-monto')?.value) || 0;
                
                if (nombre && monto > 0) {
                    miscelaneos.push({ nombre, monto });
                }
            });
            
            // Recolectar imprevistos
            const imprevistos = [];
            const imprevistosElements = document.querySelectorAll('#imprevistos-container .gasto-item');
            imprevistosElements.forEach(impEl => {
                const nombre = impEl.querySelector('.imprevisto-nombre-input')?.value || '';
                const monto = parseFloat(impEl.querySelector('.imprevisto-monto')?.value) || 0;
                const mes = impEl.querySelector('.imprevisto-mes')?.value || '';
                const dia = parseInt(impEl.querySelector('.imprevisto-dia')?.value) || 0;
                
                if (nombre && monto > 0) {
                    imprevistos.push({ nombre, monto, mes, dia });
                }
            });
            
            // Calcular totales
            const montoPago1 = parseFloat(document.getElementById('monto-pago1').value) || 0;
            const montoPago2 = parseFloat(document.getElementById('monto-pago2').value) || 0;
            const montoPago3 = parseFloat(document.getElementById('monto-pago3')?.value) || 0;
            const montoPago4 = parseFloat(document.getElementById('monto-pago4')?.value) || 0;
            const tipoPago = document.querySelector('input[name="tipo-pago"]:checked').value;
            const esSemanal = tipoPago === 'semanal';
            
            const totalIngresos = esSemanal ? (montoPago1 + montoPago2 + montoPago3 + montoPago4) : (montoPago1 + montoPago2);
            const balanceActual = parseFloat(document.getElementById('balance-actual').value) || 0;
            const gastoGasolina = parseFloat(document.getElementById('gasto-gasolina')?.value) || 0;
            const gastoComida = parseFloat(document.getElementById('gasto-comida')?.value) || 0;
            
            const totalGastosFijos = gastosFijos.reduce((sum, g) => sum + g.monto, 0);
            const totalTarjetas = tarjetas.reduce((sum, t) => sum + t.minimo, 0);
            const totalMiscelaneos = miscelaneos.reduce((sum, m) => sum + m.monto, 0);
            const totalImprevistos = imprevistos.reduce((sum, i) => sum + i.monto, 0);
            const totalGastosVariables = gastoGasolina + gastoComida;
            
            const totalGastos = totalGastosFijos + totalTarjetas + totalMiscelaneos + totalImprevistos + totalGastosVariables;
            const capitalTotal = totalIngresos + balanceActual;
            const sobrante = capitalTotal - totalGastos - metaAhorro;
            
            // Obtener datos actuales del formulario
            const datos = {
                // Metadata
                fecha: new Date().toISOString(),
                mes: parseInt(mesActual),
                a침o: a침oActual,
                nombreMes: nombreMes,
                
                // PayChecks
                tipoPago: tipoPago,
                paycheck1: {
                    mes: parseInt(document.getElementById('mes-pago1').value),
                    dia: parseInt(document.getElementById('dia-pago1').value),
                    monto: montoPago1
                },
                paycheck2: {
                    mes: parseInt(document.getElementById('mes-pago2').value),
                    dia: parseInt(document.getElementById('dia-pago2').value),
                    monto: montoPago2
                },
                paycheck3: esSemanal ? {
                    mes: parseInt(document.getElementById('mes-pago3').value),
                    dia: parseInt(document.getElementById('dia-pago3').value),
                    monto: montoPago3
                } : null,
                paycheck4: esSemanal ? {
                    mes: parseInt(document.getElementById('mes-pago4').value),
                    dia: parseInt(document.getElementById('dia-pago4').value),
                    monto: montoPago4
                } : null,
                
                // Capital y ahorro
                balanceActual: balanceActual,
                metaAhorro: metaAhorro,
                tipoAhorro: tipoAhorro,
                objetivoAhorro: objetivoAhorro,
                
                // Gastos variables
                gastoGasolina: gastoGasolina,
                gastoComida: gastoComida,
                
                // Todos los gastos detallados
                gastosFijos: gastosFijos,
                tarjetas: tarjetas,
                miscelaneos: miscelaneos,
                imprevistos: imprevistos,
                
                // Totales calculados
                totalIngresos: totalIngresos,
                capitalTotal: capitalTotal,
                totalGastosFijos: totalGastosFijos,
                totalTarjetas: totalTarjetas,
                totalMiscelaneos: totalMiscelaneos,
                totalImprevistos: totalImprevistos,
                totalGastosVariables: totalGastosVariables,
                totalGastos: totalGastos,
                sobrante: sobrante,
                ahorroReal: Math.max(sobrante, 0),
                cumplioMetaAhorro: sobrante >= 0
            };
            
            // Guardar en localStorage
            try {
                localStorage.setItem(clave, JSON.stringify(datos));
                localStorage.setItem('ultimo_mes_guardado', clave);
                
                // Si hay objetivo de ahorro, guardar/actualizar en el tracking global
                if (objetivoAhorro && metaAhorro > 0) {
                    // Guardar solo la meta mensual, NO el sobrante total
                    const ahorroParaObjetivo = sobrante >= 0 ? metaAhorro : 0;
                    guardarProgresoObjetivo(objetivoAhorro, ahorroParaObjetivo, nombreMes, a침oActual);
                }
                
                let mensaje = `九 춰Mes guardado exitosamente!\n\n游늰 ${nombreMes} ${a침oActual}\n游눯 Ingresos: ${datos.totalIngresos.toFixed(2)}\n游눶 Gastos: ${datos.totalGastos.toFixed(2)}`;
                
                if (metaAhorro > 0) {
                    mensaje += `\n游눑 Meta de ahorro: ${metaAhorro.toFixed(2)}`;
                    if (sobrante >= 0) {
                        mensaje += `\n九 Ahorro logrado: ${sobrante.toFixed(2)}`;
                    } else {
                        mensaje += `\n丘멆잺 No se pudo cumplir la meta (faltaron ${Math.abs(sobrante).toFixed(2)})`;
                    }
                }
                
                if (objetivoAhorro) {
                    const progreso = calcularProgresoTotal(objetivoAhorro.fechaObjetivo);
                    mensaje += `\n\n游꿢 Progreso hacia tu objetivo:\n${progreso.porcentaje.toFixed(1)}% completado (${progreso.ahorrado.toFixed(2)} de ${objetivoAhorro.metaTotal.toFixed(2)})`;
                }
                
                mensaje += `\n\n游늵 Puedes ver el historial en "游늭 Ver Meses Anteriores"`;
                
                alert(mensaje);
            } catch (error) {
                console.error('Error al guardar:', error);
                alert('仇 Error al guardar el mes. Tu navegador puede tener el almacenamiento deshabilitado.');
            }
        }
        
        function guardarProgresoObjetivo(objetivo, ahorroReal, nombreMes, a침o) {
            const claveObjetivo = `objetivo_${objetivo.fechaObjetivo}`;
            let tracking = localStorage.getItem(claveObjetivo);
            
            if (tracking) {
                tracking = JSON.parse(tracking);
            } else {
                tracking = {
                    fechaObjetivo: objetivo.fechaObjetivo,
                    metaTotal: objetivo.metaTotal,
                    mesesAhorro: []
                };
            }
            
            // Verificar si este mes ya existe (actualizar en lugar de duplicar)
            const indiceExistente = tracking.mesesAhorro.findIndex(m => m.mes === nombreMes && m.a침o === a침o);
            
            const registroMes = {
                mes: nombreMes,
                a침o: a침o,
                monto: ahorroReal, // Guardar el ahorro REAL logrado
                fecha: new Date().toISOString()
            };
            
            if (indiceExistente >= 0) {
                // Actualizar mes existente
                tracking.mesesAhorro[indiceExistente] = registroMes;
            } else {
                // Agregar nuevo mes
                tracking.mesesAhorro.push(registroMes);
            }
            
            localStorage.setItem(claveObjetivo, JSON.stringify(tracking));
        }
        
        function calcularProgresoTotal(fechaObjetivo) {
            const claveObjetivo = `objetivo_${fechaObjetivo}`;
            const tracking = localStorage.getItem(claveObjetivo);
            
            if (!tracking) {
                return { ahorrado: 0, porcentaje: 0 };
            }
            
            const data = JSON.parse(tracking);
            const totalAhorrado = data.mesesAhorro.reduce((sum, m) => sum + m.monto, 0);
            const porcentaje = (totalAhorrado / data.metaTotal) * 100;
            
            return {
                ahorrado: totalAhorrado,
                porcentaje: Math.min(porcentaje, 100),
                meta: data.metaTotal
            };
        }
        
        function verHistorial() {
            const modal = document.getElementById('modalHistorial');
            const content = document.getElementById('historialContent');
            
            // Obtener todos los meses guardados
            const mesesGuardados = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('finanzas_')) {
                    try {
                        const datos = JSON.parse(localStorage.getItem(key));
                        mesesGuardados.push({ key, ...datos });
                    } catch (e) {
                        console.error('Error al leer:', key, e);
                    }
                }
            }
            
            // Ordenar por fecha (m치s reciente primero)
            mesesGuardados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (mesesGuardados.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>游늭 No hay meses guardados todav칤a</h3>
                        <p>Calcula tu plan financiero y presiona "游 Guardar Este Mes" para empezar tu historial.</p>
                    </div>
                `;
            } else {
                let html = '<div style="margin-bottom: 20px;">';
                
                mesesGuardados.forEach(mes => {
                    const sobrante = mes.sobrante || 0;
                    const esPositivo = sobrante >= 0;
                    const cumplioMeta = mes.cumplioMetaAhorro !== false;
                    
                    html += `
                        <div class="month-card">
                            <div class="month-card-header">
                                <div class="month-card-title">游늰 ${mes.nombreMes} ${mes.a침o}</div>
                                <span class="month-card-status ${esPositivo ? 'status-positive' : 'status-negative'}">
                                    ${esPositivo ? '九 Ahorro' : '仇 D칠ficit'}
                                </span>
                            </div>
                            <div class="month-card-details">
                                <div class="month-detail">
                                    游눯 <strong>Ingresos:</strong><br>${(mes.totalIngresos || 0).toFixed(2)}
                                </div>
                                <div class="month-detail">
                                    游눶 <strong>Gastos:</strong><br>${(mes.totalGastos || 0).toFixed(2)}
                                </div>
                                <div class="month-detail">
                                    游눳 <strong>Balance Inicial:</strong><br>${(mes.balanceActual || 0).toFixed(2)}
                                </div>
                                <div class="month-detail">
                                    ${esPositivo ? '游눑 <strong>Ahorrado:</strong>' : '丘멆잺 <strong>Faltante:</strong>'}<br>
                                    <span style="color: ${esPositivo ? '#37b24d' : '#ff6b6b'};">${Math.abs(sobrante).toFixed(2)}</span>
                                </div>
                            </div>
                            
                            ${mes.metaAhorro > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: ${cumplioMeta ? '#e8f5e9' : '#fff3e0'}; border-radius: 8px; font-size: 0.9em;">
                                游꿢 <strong>Meta de ahorro:</strong> ${mes.metaAhorro.toFixed(2)} 
                                ${cumplioMeta ? '九 Cumplida' : '丘멆잺 No cumplida'}
                            </div>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; padding: 10px; background: #f8f9ff; border-radius: 8px; font-weight: bold;">
                                    游늶 Ver detalles completos
                                </summary>
                                <div style="margin-top: 10px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    ${mes.gastosFijos && mes.gastosFijos.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #667eea;">游눱 Gastos Fijos (${mes.gastosFijos.length}):</strong>
                                        <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                            ${mes.gastosFijos.map(g => `<li>${g.nombre}: ${g.monto.toFixed(2)} (D칤a ${g.dia})</li>`).join('')}
                                        </ul>
                                        <div style="text-align: right; font-weight: bold; margin-top: 5px;">Total: ${(mes.totalGastosFijos || 0).toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                    
                                    ${mes.gastoGasolina > 0 || mes.gastoComida > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #51cf66;">游뚱 Gastos Variables:</strong>
                                        <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                            ${mes.gastoGasolina > 0 ? `<li>久 Gasolina: ${mes.gastoGasolina.toFixed(2)}</li>` : ''}
                                            ${mes.gastoComida > 0 ? `<li>游꼢 Comida: ${mes.gastoComida.toFixed(2)}</li>` : ''}
                                        </ul>
                                        <div style="text-align: right; font-weight: bold; margin-top: 5px;">Total: ${(mes.totalGastosVariables || 0).toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                    
                                    ${mes.tarjetas && mes.tarjetas.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #667eea;">游눱 Tarjetas (${mes.tarjetas.length}):</strong>
                                        <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                            ${mes.tarjetas.map(t => `<li>${t.nombre}: M칤nimo ${t.minimo.toFixed(2)} / Deuda ${t.deuda.toFixed(2)}</li>`).join('')}
                                        </ul>
                                        <div style="text-align: right; font-weight: bold; margin-top: 5px;">Total m칤nimos: ${(mes.totalTarjetas || 0).toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                    
                                    ${mes.miscelaneos && mes.miscelaneos.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #f59f00;">游꿢 Miscel치neos (${mes.miscelaneos.length}):</strong>
                                        <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                            ${mes.miscelaneos.map(m => `<li>${m.nombre}: ${m.monto.toFixed(2)}</li>`).join('')}
                                        </ul>
                                        <div style="text-align: right; font-weight: bold; margin-top: 5px;">Total: ${(mes.totalMiscelaneos || 0).toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                    
                                    ${mes.imprevistos && mes.imprevistos.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #ff6b6b;">游뚿 Imprevistos (${mes.imprevistos.length}):</strong>
                                        <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                            ${mes.imprevistos.map(i => `<li>${i.nombre}: ${i.monto.toFixed(2)}</li>`).join('')}
                                        </ul>
                                        <div style="text-align: right; font-weight: bold; margin-top: 5px;">Total: ${(mes.totalImprevistos || 0).toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </details>
                            
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button onclick="cargarMes('${mes.key}')" class="btn-secondary" style="flex: 1; padding: 10px;">
                                    游닌 Cargar
                                </button>
                                <button onclick="eliminarMes('${mes.key}')" class="btn-danger" style="flex: 1; padding: 10px;">
                                    游딈勇 Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            }
            
            modal.classList.add('show');
        }
        
        function compararMeses() {
            // Obtener todos los meses guardados
            const mesesGuardados = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('finanzas_')) {
                    try {
                        const datos = JSON.parse(localStorage.getItem(key));
                        mesesGuardados.push(datos);
                    } catch (e) {
                        console.error('Error:', e);
                    }
                }
            }
            
            if (mesesGuardados.length < 2) {
                alert('游늵 Necesitas al menos 2 meses guardados para comparar.\n\nGuarda m치s meses usando el bot칩n "游 Guardar Este Mes"');
                return;
            }
            
            // Ordenar por fecha
            mesesGuardados.sort((a, b) => {
                const fechaA = new Date(a.a침o, a.mes - 1);
                const fechaB = new Date(b.a침o, b.mes - 1);
                return fechaA - fechaB;
            });
            
            const modal = document.getElementById('modalComparacion');
            modal.classList.add('show');
            
            // Preparar datos para la gr치fica
            setTimeout(() => {
                const ctx = document.getElementById('comparacionChart');
                if (ctx) {
                    const labels = mesesGuardados.map(m => `${m.nombreMes} ${m.a침o}`);
                    const ingresos = mesesGuardados.map(m => m.totalIngresos);
                    const balance = mesesGuardados.map(m => m.balanceActual || 0);
                    const metasAhorro = mesesGuardados.map(m => m.metaAhorro || 0);
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Ingresos Totales',
                                    data: ingresos,
                                    borderColor: '#51cf66',
                                    backgroundColor: 'rgba(81, 207, 102, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Balance Actual',
                                    data: balance,
                                    borderColor: '#667eea',
                                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Meta de Ahorro',
                                    data: metasAhorro,
                                    borderColor: '#f59f00',
                                    backgroundColor: 'rgba(245, 159, 0, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toFixed(0);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Mostrar estad칤sticas
                const promIngresos = ingresos.reduce((a, b) => a + b, 0) / ingresos.length;
                const promBalance = balance.reduce((a, b) => a + b, 0) / balance.length;
                
                document.getElementById('comparacionStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #666;">Promedio Ingresos</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #37b24d;">$${promIngresos.toFixed(2)}</div>
                        </div>
                        <div style="background: #e8eaff; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #666;">Promedio Balance</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">$${promBalance.toFixed(2)}</div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #666;">Meses Registrados</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #f57c00;">${mesesGuardados.length}</div>
                        </div>
                    </div>
                `;
            }, 100);
        }
        
        function verProgresoAhorro() {
            const modal = document.getElementById('modalProgreso');
            const content = document.getElementById('progresoContent');
            
            // Buscar todos los objetivos de ahorro guardados
            const objetivos = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('objetivo_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        objetivos.push(data);
                    } catch (e) {
                        console.error('Error al leer objetivo:', e);
                    }
                }
            }
            
            if (objetivos.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>游늵 No hay objetivos de ahorro registrados</h3>
                        <p style="margin-top: 15px;">Para empezar a hacer seguimiento:</p>
                        <ol style="text-align: left; max-width: 400px; margin: 20px auto; line-height: 1.8;">
                            <li>Selecciona "Ahorro con fecha objetivo" en el formulario</li>
                            <li>Define tu meta y fecha</li>
                            <li>Calcula y guarda el mes con "游 Guardar Este Mes"</li>
                            <li>Repite cada mes para ver tu progreso aqu칤</li>
                        </ol>
                    </div>
                `;
            } else {
                let html = '';
                
                objetivos.forEach(obj => {
                    const totalAhorrado = obj.mesesAhorro.reduce((sum, m) => sum + m.monto, 0);
                    const porcentaje = Math.min((totalAhorrado / obj.metaTotal) * 100, 100);
                    const falta = Math.max(obj.metaTotal - totalAhorrado, 0);
                    
                    // Parsear fecha
                    const fechaObj = new Date(obj.fechaObjetivo);
                    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    const fechaTexto = `${fechaObj.getDate()} de ${meses[fechaObj.getMonth()]} ${fechaObj.getFullYear()}`;
                    
                    // Calcular d칤as restantes
                    const hoy = new Date();
                    const diasRestantes = Math.ceil((fechaObj - hoy) / (1000 * 60 * 60 * 24));
                    const yaLleg칩 = diasRestantes <= 0;
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid ${porcentaje >= 100 ? '#4caf50' : '#ff9800'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #667eea;">游꿢 Objetivo: ${fechaTexto}</h3>
                                ${porcentaje >= 100 ? '<span style="background: #4caf50; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">九 Completado</span>' : 
                                  yaLleg칩 ? '<span style="background: #ff6b6b; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">丘멆잺 Fecha pasada</span>' :
                                  `<span style="background: #ff9800; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">낍 ${diasRestantes} d칤as restantes</span>`}
                            </div>
                            
                            <!-- Barra de progreso -->
                            <div style="background: #e9ecef; height: 40px; border-radius: 20px; overflow: hidden; margin-bottom: 15px; position: relative;">
                                <div style="background: linear-gradient(90deg, #4caf50, #2e7d32); height: 100%; width: ${porcentaje}%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${porcentaje.toFixed(1)}%
                                </div>
                            </div>
                            
                            <!-- Estad칤sticas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 0.9em; color: #666;">Meta Total</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">$${obj.metaTotal.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 0.9em; color: #666;">Ahorrado</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;">$${totalAhorrado.toFixed(2)}</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 0.9em; color: #666;">${porcentaje >= 100 ? 'Excedente' : 'Falta'}</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: ${porcentaje >= 100 ? '#4caf50' : '#ff9800'};">$${falta.toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <!-- Historial de meses -->
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; padding: 10px; background: white; border-radius: 8px; font-weight: bold;">
                                    游늶 Ver historial de ${obj.mesesAhorro.length} ${obj.mesesAhorro.length === 1 ? 'mes' : 'meses'} guardados
                                </summary>
                                <div style="margin-top: 10px; background: white; padding: 15px; border-radius: 8px;">
                                    ${obj.mesesAhorro.map((m, idx) => `
                                        <div style="padding: 8px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;">
                                            <span>${idx + 1}. ${m.mes} ${m.a침o}</span>
                                            <strong style="color: #4caf50;">$${m.monto.toFixed(2)}</strong>
                                        </div>
                                    `).join('')}
                                    ${obj.mesesAhorro.length === 0 ? '<p style="color: #999;">A칰n no has guardado ning칰n mes</p>' : ''}
                                </div>
                            </details>
                            
                            <!-- Bot칩n de eliminar objetivo -->
                            <button onclick="eliminarObjetivo('${obj.fechaObjetivo}')" style="margin-top: 15px; background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%;">
                                游딈勇 Eliminar este objetivo
                            </button>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            }
            
            modal.classList.add('show');
        }
        
        function eliminarObjetivo(fechaObjetivo) {
            if (confirm(`쮼st치s seguro de eliminar el objetivo para ${fechaObjetivo}?\n\nSe perder치 todo el historial de ahorro asociado.`)) {
                const claveObjetivo = `objetivo_${fechaObjetivo}`;
                localStorage.removeItem(claveObjetivo);
                alert('九 Objetivo eliminado correctamente.');
                verProgresoAhorro(); // Recargar
            }
        }
        
        function cargarMes(key) {
            if (!confirm('쯈uieres cargar los datos de este mes? Los datos actuales en el formulario se reemplazar치n.')) {
                return;
            }
            
            try {
                const datos = JSON.parse(localStorage.getItem(key));
                
                // Cargar datos en el formulario
                document.getElementById('mes-pago1').value = datos.paycheck1.mes;
                document.getElementById('dia-pago1').value = datos.paycheck1.dia;
                document.getElementById('monto-pago1').value = datos.paycheck1.monto;
                
                document.getElementById('mes-pago2').value = datos.paycheck2.mes;
                document.getElementById('dia-pago2').value = datos.paycheck2.dia;
                document.getElementById('monto-pago2').value = datos.paycheck2.monto;
                
                document.getElementById('balance-actual').value = datos.balanceActual;
                document.getElementById('meta-ahorro').value = datos.metaAhorro;
                
                cerrarModal('modalHistorial');
                alert(`九 Datos de ${datos.nombreMes} ${datos.a침o} cargados.\n\nPresiona "CALCULAR" para ver los resultados.`);
                
                // Scroll hacia arriba
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                alert('仇 Error al cargar los datos del mes.');
                console.error(error);
            }
        }
        
        function eliminarMes(key) {
            const datos = JSON.parse(localStorage.getItem(key));
            
            if (confirm(`쮼st치s seguro de eliminar ${datos.nombreMes} ${datos.a침o}?\n\nEsta acci칩n no se puede deshacer.`)) {
                localStorage.removeItem(key);
                alert('九 Mes eliminado correctamente.');
                verHistorial(); // Recargar el historial
            }
        }
        
        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
        
        // ==================== VALIDACI칍N DE FECHAS ====================
        
        function validarDiaDelMes(mes, dia) {
            const diasPorMes = {
                1: 31, 2: 28, 3: 31, 4: 30, 5: 31, 6: 30,
                7: 31, 8: 31, 9: 30, 10: 31, 11: 30, 12: 31
            };
            
            const maxDias = diasPorMes[parseInt(mes)] || 31;
            return parseInt(dia) <= maxDias;
        }
        
        function obtenerNombreMes(numeroMes) {
            const meses = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return meses[parseInt(numeroMes)] || '';
        }
        
        // Agregar validaci칩n a todos los inputs de d칤a
        document.addEventListener('DOMContentLoaded', function() {
            // Validar d칤as de servicios cuando cambien mes o d칤a
            document.querySelectorAll('.servicio-mes, .servicio-dia').forEach(input => {
                input.addEventListener('change', function() {
                    const contenedor = this.closest('.gasto-categoria');
                    if (contenedor) {
                        const mesSelect = contenedor.querySelector('.servicio-mes');
                        const diaInput = contenedor.querySelector('.servicio-dia');
                        
                        if (mesSelect && diaInput && diaInput.value) {
                            const mes = mesSelect.value;
                            const dia = diaInput.value;
                            
                            if (mes !== 'todos' && !validarDiaDelMes(mes, dia)) {
                                const nombreMes = obtenerNombreMes(mes);
                                const diasPorMes = {1:31,2:28,3:31,4:30,5:31,6:30,7:31,8:31,9:30,10:31,11:30,12:31};
                                const maxDias = diasPorMes[parseInt(mes)];
                                
                                alert(`丘멆잺 ${nombreMes} solo tiene ${maxDias} d칤as.\n\nPor favor ingresa un d칤a v치lido (1-${maxDias}).`);
                                diaInput.value = '';
                                diaInput.focus();
                            }
                        }
                    }
                });
            });
            
            // Validar d칤as de tarjetas
            document.querySelectorAll('.tarjeta-mes, .tarjeta-dia').forEach(input => {
                input.addEventListener('change', function() {
                    const contenedor = this.closest('.gasto-categoria');
                    if (contenedor) {
                        const mesSelect = contenedor.querySelector('.tarjeta-mes');
                        const diaInput = contenedor.querySelector('.tarjeta-dia');
                        
                        if (mesSelect && diaInput && diaInput.value) {
                            const mes = mesSelect.value;
                            const dia = diaInput.value;
                            
                            if (!validarDiaDelMes(mes, dia)) {
                                const nombreMes = obtenerNombreMes(mes);
                                const diasPorMes = {1:31,2:28,3:31,4:30,5:31,6:30,7:31,8:31,9:30,10:31,11:30,12:31};
                                const maxDias = diasPorMes[parseInt(mes)];
                                
                                alert(`丘멆잺 ${nombreMes} solo tiene ${maxDias} d칤as.\n\nPor favor ingresa un d칤a v치lido (1-${maxDias}).`);
                                diaInput.value = '';
                                diaInput.focus();
                            }
                        }
                    }
                });
            });
            
            // Validar d칤as de imprevistos
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('imprevisto-dia')) {
                    const dia = parseInt(e.target.value);
                    if (dia > 31) {
                        alert('丘멆잺 El d칤a no puede ser mayor a 31.');
                        e.target.value = '';
                    }
                }
            });
        });
        
        // ==================== FIN VALIDACI칍N ====================
        
        // ==================== FIN FUNCIONES DE GUARDADO ====================
        
        function exportarPDF() {
            const elemento = document.getElementById('resultado');
            
            if (!elemento || elemento.innerHTML === '') {
                alert('丘멆잺 Primero debes calcular tu plan financiero antes de exportar a PDF');
                return;
            }
            
            // Intentar imprimir con timeout para dar tiempo al navegador
            try {
                setTimeout(() => {
                    window.print();
                }, 100);
                
                // Mostrar instrucciones despu칠s de intentar imprimir
                setTimeout(() => {
                    // Solo mostrar si todav칤a no se abri칩 el di치logo
                    alert('游눠 Si no se abri칩 el di치logo de impresi칩n:\n\n游둰勇 Computadora:\n   Presiona Ctrl+P (Windows) o Cmd+P (Mac)\n\n游님 iPhone/iPad:\n   Toca el bot칩n Compartir 游댕 arriba\n   Selecciona "Imprimir"\n   O toma screenshot y comp치rtelo');
                }, 500);
            } catch (error) {
                console.error('仇 Error al imprimir:', error);
                alert('仇 Error al imprimir. Usa el atajo de teclado:\n\n Ctrl+P (Windows)\n Cmd+P (Mac)\n\nO el men칰 del navegador: Archivo  Imprimir');
            }
        }
        
        // ==================== ATAJOS DE TECLADO GLOBALES ====================
        
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter o Cmd+Enter  Calcular
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                calcularFinanzas();
            }
            
            // Ctrl+N o Cmd+N  Agregar nueva fila de gasto fijo
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                agregarFilaGastoFijo();
            }
            
            // Escape  Cerrar mensajes de error/칠xito y tooltips
            if (e.key === 'Escape') {
                const errorContainer = document.getElementById('error-container');
                const successContainer = document.getElementById('success-container');
                const versionBanner = document.getElementById('version-banner');
                
                if (errorContainer) errorContainer.classList.remove('show');
                if (successContainer) successContainer.classList.remove('show');
                
                // Cerrar ayuda expandida si est치 abierta
                const helpHeaders = document.querySelectorAll('.collapsible-header.active');
                helpHeaders.forEach(header => {
                    header.classList.remove('active');
                    const content = header.nextElementSibling;
                    if (content) content.classList.remove('active');
                });
            }
        });
        
        // Auto-focus en el primer input al cargar la p치gina
        window.addEventListener('load', function() {
            const primerInput = document.getElementById('balance-actual');
            if (primerInput) {
                setTimeout(() => primerInput.focus(), 500);
            }
        });
        
        // Global error handler to catch and suppress generic "Script error" messages
        window.addEventListener('error', function(event) {
            // If it's a generic "Script error" with no details, it's usually a CDN/CORS issue
            // that doesn't need to be shown to the user
            if (event.message === 'Script error.') {
                event.preventDefault();
                console.log('丘멆잺 Script error suprimido (probablemente CDN/CORS)');
            }
        });
        
        // ==================== REGISTRO PWA SERVICE WORKER ====================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('九 Service Worker registrado:', registration.scope);

                        const mostrarToast = () => {
                            const toast = document.getElementById('toast-actualizacion');
                            const btn = document.getElementById('btn-actualizar-sw');
                            if (!toast || !btn) return;
                            toast.classList.add('show');
                            btn.onclick = () => {
                                if (registration.waiting) {
                                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                }
                            };
                        };

                        if (registration.waiting) mostrarToast();

                        registration.addEventListener('updatefound', () => {
                            const nuevoSW = registration.installing;
                            nuevoSW.addEventListener('statechange', () => {
                                if (nuevoSW.state === 'installed' && navigator.serviceWorker.controller) {
                                    mostrarToast();
                                }
                            });
                        });
                    })
                    .catch(error => console.log('仇 Error al registrar Service Worker:', error));
            });

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
    </script>
    
    <!-- Toast de actualizaci칩n de versi칩n -->
    <div id="toast-actualizacion" class="toast-update">
        <span>游댃 Nueva versi칩n disponible</span>
        <button id="btn-actualizar-sw">Actualizar ahora</button>
        <button onclick="this.closest('.toast-update').classList.remove('show')" aria-label="Cerrar">九</button>
    </div>

    <!-- Sistema de Notificaciones Push v3.0 -->
    <script src="./notifications.js"></script>

</body>
</html>
